<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <title>Project: NTU_LEGACY | 台大實境解謎</title>
  <link rel="icon" type="image/png" href="images/logo.png" />

  <!-- 引入字體與圖標 -->
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    /* --- 0. 核心變數 (Cyberpunk Theme) --- */
    :root {
      --bg-color: #0b1121;
      --card-bg: #151e32;
      --border-color: #334155;
      --text-main: #e2e8f0;
      --text-sub: #94a3b8;
      --accent-cyan: #38bdf8;
      --accent-pink: #d946ef;
      --accent-yellow: #fbbf24;
      --danger: #ef4444;
      --success: #10b981;

      --slate-300: #cbd5e1;
      --slate-400: #94a3b8;
      --slate-500: #64748b;
      --slate-600: #475569;
      --slate-700: #334155;
      --slate-800: #1e293b;
      --slate-900: #0f172a;
    }

    /* --- 1. 全局設定 --- */
    * { box-sizing: border-box; }
    body {
      background-color: var(--bg-color);
      color: var(--text-main);
      font-family: 'Noto Sans TC', sans-serif;
      margin: 0; padding: 0;
      height: 100vh;
      display: flex; flex-direction: column;
      overflow: hidden;
      touch-action: manipulation;
    }

    /* ✅ 補齊：scanline / neon-glow（你有用到但沒定義） */
    .scanline{
      pointer-events:none;
      position:fixed; inset:0;
      background: repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,0.03) 0px,
        rgba(255,255,255,0.03) 1px,
        rgba(0,0,0,0) 3px,
        rgba(0,0,0,0) 6px
      );
      mix-blend-mode: overlay;
      opacity: 0.25;
      z-index: 1;
    }
    .neon-glow{
      pointer-events:none;
      position:fixed; inset:-40px;
      background: radial-gradient(circle at 50% 30%, rgba(217,70,239,0.15), transparent 55%),
                  radial-gradient(circle at 20% 80%, rgba(56,189,248,0.12), transparent 55%);
      filter: blur(12px);
      z-index: 1;
    }

    /* --- 2. 實用類別 --- */
    .w-full { width: 100%; }
    .h-full { height: 100%; }
    .flex { display: flex; }
    .flex-col { flex-direction: column; }
    .items-center { align-items: center; }
    .justify-center { justify-content: center; }
    .justify-between { justify-content: space-between; }
    .gap-1 { gap: 4px; }
    .gap-2 { gap: 8px; }
    .gap-3 { gap: 12px; }
    .gap-4 { gap: 16px; }
    .text-center { text-align: center; }
    .text-left { text-align: left; }
    .relative { position: relative; }
    .absolute { position: absolute; }
    .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
    .z-10 { z-index: 10; }
    .z-20 { z-index: 20; }
    .hidden { display: none !important; }
    .block { display: block; }
    .inline-block { display: inline-block; }
    .inline-flex { display: inline-flex; }
    .mono { font-family: 'JetBrains Mono', monospace; }
    .font-bold { font-weight: bold; }
    .tracking-widest { letter-spacing: 0.1em; }
    .leading-relaxed { line-height: 1.625; }

    .text-white { color: white; }
    .text-slate-300 { color: var(--slate-300); }
    .text-slate-400 { color: var(--slate-400); }
    .text-slate-500 { color: var(--slate-500); }
    .text-ntu-accent { color: var(--accent-cyan); }
    .text-fuchsia-400 { color: var(--accent-pink); }
    .text-emerald-400 { color: #34d399; }
    .text-emerald-500 { color: var(--success); }
    .text-red-400 { color: #f87171; }
    .text-red-500 { color: var(--danger); }
    .text-ntu-yellow { color: var(--accent-yellow); }

    .bg-ntu-bg { background-color: var(--bg-color); }
    .bg-ntu-card { background-color: var(--card-bg); }
    .bg-slate-800 { background-color: var(--slate-800); }
    .bg-slate-900 { background-color: var(--slate-900); }
    .bg-fuchsia-500 { background-color: var(--accent-pink); }
    .bg-emerald-500 { background-color: var(--success); }
    .bg-red-600 { background-color: #dc2626; }
    .bg-transparent { background-color: transparent; }

    .border { border-width: 1px; border-style: solid; }
    .border-2 { border-width: 2px; border-style: solid; }
    .border-4 { border-width: 4px; border-style: solid; }
    .border-ntu-border { border-color: var(--border-color); }
    .border-slate-600 { border-color: var(--slate-600); }
    .border-slate-700 { border-color: var(--slate-700); }
    .border-fuchsia-500 { border-color: var(--accent-pink); }
    .border-emerald-500 { border-color: var(--success); }
    .border-red-500 { border-color: var(--danger); }

    .border-l-4 { border-left-width: 4px; border-style: solid; }
    .border-l-2 { border-left-width: 2px; border-style: solid; }
    .border-t { border-top-width: 1px; border-style: solid; }
    .border-b { border-bottom-width: 1px; border-style: solid; }

    .rounded { border-radius: 0.25rem; }
    .rounded-lg { border-radius: 0.5rem; }
    .rounded-full { border-radius: 9999px; }

    .p-2 { padding: 0.5rem; }
    .p-3 { padding: 0.75rem; }
    .p-4 { padding: 1rem; }
    .p-8 { padding: 2rem; }
    .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
    .px-8 { padding-left: 2rem; padding-right: 2rem; }
    .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
    .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
    .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
    .mb-2 { margin-bottom: 0.5rem; }
    .mb-3 { margin-bottom: 0.75rem; }
    .mb-4 { margin-bottom: 1rem; }
    .mb-6 { margin-bottom: 1.5rem; }
    .mb-8 { margin-bottom: 2rem; }
    .mt-1 { margin-top: 0.25rem; }
    .mt-2 { margin-top: 0.5rem; }
    .mt-3 { margin-top: 0.75rem; }
    .mt-4 { margin-top: 1rem; }
    .mr-1 { margin-right: 0.25rem; }
    .mr-2 { margin-right: 0.5rem; }
    .pl-3 { padding-left: 0.75rem; }
    .pt-6 { padding-top: 1.5rem; }
    .pb-3 { padding-bottom: 0.75rem; }

    .grid { display: grid; }
    .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
    .overflow-hidden { overflow: hidden; }
    .object-cover { object-fit: cover; }
    .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
    .shadow-neon { box-shadow: 0 0 10px rgba(56, 189, 248, 0.5); }
    .fade-in { animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* ✅ 補齊：你有用到但沒定義的 UI class，避免「看起來像空白」 */
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .card{
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.35);
      margin-bottom: 16px;
    }
    .section-title{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      padding: 10px 12px;
      margin-bottom: 12px;
      border-left: 4px solid var(--accent-pink);
      background: rgba(255,255,255,0.03);
      border-radius: 10px;
    }
    .section-title h2{
      margin: 2px 0 0 0;
      font-size: 1.2rem;
      color: white;
    }
    .img-container{
      width:100%;
      border-radius: 10px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,0.06);
      margin-bottom: 12px;
      background: rgba(0,0,0,0.2);
    }
    .img-cover{ width:100%; height: 200px; object-fit: cover; display:block; }
    .text-sub{ color: var(--text-sub); }

    /* --- 3. 主要版面區塊 --- */
    header {
      position: fixed; top: 0; left: 0; width: 100%; height: 60px;
      background: rgba(11, 17, 33, 0.95); backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border-color);
      display: flex; justify-content: space-between; align-items: center;
      padding: 0 16px; z-index: 50;
    }

    /* ✅ 補齊：team badge / reset btn（你有用到但沒定義） */
    .team-badge{
      padding: 6px 10px;
      border: 1px solid var(--border-color);
      border-radius: 999px;
      color: var(--text-sub);
      font-size: 0.8rem;
      margin-right: 10px;
    }
    .reset-btn{
      background: rgba(239,68,68,0.1);
      color: #fecaca;
      border: 1px solid rgba(239,68,68,0.35);
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
    }
    .header-controls{ display:flex; align-items:center; gap:10px; }

    main {
      flex: 1; width: 100%; max-width: 480px; margin: 0 auto;
      padding: 80px 16px 100px 16px;
      overflow-y: auto; position: relative; z-index: 10;
    }

    nav {
      position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
      width: 100%; max-width: 480px; height: 70px;
      background: var(--bg-color); border-top: 1px solid var(--border-color);
      display: grid; grid-template-columns: 1fr 1fr 1fr;
      z-index: 50; box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
    }
    nav button {
      background: none; border: none; color: var(--text-sub);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      gap: 4px; font-size: 0.7rem; cursor: pointer; transition: color 0.3s;
    }
    nav button i { font-size: 1.4rem; margin-bottom: 2px; }
    nav button.active { color: var(--accent-pink); text-shadow: 0 0 10px rgba(217, 70, 239, 0.3); }

    /* --- 4. 按鈕、輸入框、轉盤 --- */
    .btn-neon {
      width: 100%; padding: 14px;
      background: linear-gradient(90deg, #d946ef 0%, #7c3aed 100%);
      color: white; font-weight: bold; border: none; border-radius: 8px;
      font-size: 1rem; cursor: pointer;
      box-shadow: 0 0 15px rgba(217, 70, 239, 0.4);
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
      transition: transform 0.2s, box-shadow 0.2s;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn-neon:active { transform: scale(0.98); }

    .btn-secondary {
      width: 100%; padding: 12px;
      background: transparent; border: 1px solid var(--border-color);
      color: var(--text-sub); border-radius: 8px; font-weight: bold;
      cursor: pointer; transition: all 0.2s;
    }
    .btn-secondary:hover { border-color: var(--text-sub); color: white; background: rgba(255,255,255,0.05); }

    .term-input {
      width: 100%; background: rgba(0,0,0,0.2); border: none;
      border-bottom: 2px solid var(--border-color);
      color: var(--accent-pink); font-size: 1.2rem; text-align: center;
      padding: 10px; outline: none; font-family: 'JetBrains Mono', monospace;
      text-transform: uppercase; letter-spacing: 2px; transition: all 0.3s;
    }
    .term-input:focus { border-bottom-color: var(--accent-pink); background: rgba(217, 70, 239, 0.05); }

    /* Dial Puzzle (原樣保留) */
    .dial-wrapper {
      position: relative; width: 260px; height: 260px; margin: 20px auto;
      border-radius: 50%; background: linear-gradient(145deg, #1a233a, #0f1623);
      border: 10px solid var(--border-color);
      box-shadow: inset 0 0 20px #000; user-select: none;
    }
    .dial-track {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 170px; height: 170px; border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.05); pointer-events: none;
    }
    .dial-knob {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 160px; height: 160px; border-radius: 50%;
      background: var(--card-bg); border: 1px solid #334155;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
      display: flex; align-items: center; justify-content: center;
      z-index: 10; cursor: grab;
    }
    .dial-pointer {
      position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
      width: 0; height: 0;
      border-left: 10px solid transparent; border-right: 10px solid transparent;
      border-bottom: 18px solid var(--accent-yellow);
    }
    .dial-letter {
      position: absolute; width: 30px; height: 30px;
      text-align: center; line-height: 30px; color: var(--text-sub);
      font-weight: bold; font-family: 'JetBrains Mono', monospace;
      pointer-events: none; transform-origin: center center; font-size: 1.2rem;
    }

    /* Checkbox */
    .checkbox-group label {
      display: flex; align-items: center; padding: 12px;
      background: rgba(0,0,0,0.2); border: 1px solid var(--border-color);
      border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;
    }
    .checkbox-group label:hover { border-color: var(--accent-cyan); background: rgba(56, 189, 248, 0.1); }
    .checkbox-group input { margin-right: 12px; width: 18px; height: 18px; accent-color: var(--accent-cyan); cursor: pointer; }

    /* Toast */
    #toast {
      position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
      background: #1e293b; border: 1px solid var(--accent-pink); color: white;
      padding: 12px 24px; border-radius: 8px; z-index: 100;
      opacity: 0; transition: opacity 0.3s; pointer-events: none;
      display: flex; align-items: center; gap: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      width: max-content;
    }
    #toast.show { opacity: 1; }

    /* Intro */
    .intro-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100%; text-align: center; }
    .logo-box {
      width: 120px; height: 120px; border-radius: 50%; overflow: hidden;
      border: 4px solid rgba(217, 70, 239, 0.5);
      box-shadow: 0 0 20px rgba(217, 70, 239, 0.3); margin-bottom: 20px;
    }
    .logo-box img { width: 100%; height: 100%; object-fit: cover; }
  </style>
</head>

<body>
  <div class="scanline"></div>
  <div class="neon-glow"></div>

  <header>
    <div class="header-logo">
      <span style="color:var(--accent-pink)">&gt;_</span>
      <span class="mono" style="color:white; letter-spacing: 2px;">NTU_SYSTEM</span>
    </div>
    <div class="header-controls">
      <div id="team-display" class="team-badge"></div>
      <button onclick="app.resetGame()" class="reset-btn">
        <i class="fa-solid fa-triangle-exclamation"></i> 重置
      </button>
    </div>
  </header>

  <main id="app-container"></main>

  <nav>
    <button onclick="app.navigate('mission')" id="nav-mission">
      <i class="fa-solid fa-location-arrow"></i> <span class="mono">當前任務</span>
    </button>
    <button onclick="app.navigate('clues')" id="nav-clues">
      <i class="fa-solid fa-key"></i> <span class="mono">金鑰碎片</span>
    </button>
    <button onclick="app.navigate('final')" id="nav-final">
      <i class="fa-solid fa-lock"></i> <span class="mono">終端解碼</span>
    </button>
  </nav>

  <div id="toast">
    <i class="fa-solid fa-circle-info"></i> <span id="toast-msg">Message</span>
  </div>

  <script>
    const ADMIN_PASS = '8888';
    const FINAL_ANSWER_HASH = "REVMQ18yMDIy";

    const STAGES = {
      gate: { id:'gate', name:'台大校門', code:'2', lat:25.0174, lon:121.5339, hintTitle:'知識的入口', hintDesc:'所有旅程的起點，昔日的帝國大學門戶。', hintImage:'images/gate.jpg', icon:'fa-torii-gate', title:'時光刻度', desc:'請轉動圓盤，依發生年代將校史事件排序。', difficultyLabel:'歷史排序', type:'lock' },
      palm: { id:'palm', name:'椰林大道', code:'2', lat:25.0185, lon:121.5390, hintTitle:'熱帶的守望者', hintDesc:'筆直的大道，兩旁高聳的植物見證了無數學子的來去。', hintImage:'images/palm.jpg', icon:'fa-tree', title:'光譜密碼', desc:'尋找隱藏在椰林光影中的「台大紅」。請根據數學線索調配出正確的 RGB 數值。', difficultyLabel:'色彩數學', type:'color' },
      bell: { id:'bell', name:'傅鐘', code:'2', lat:25.0180, lon:121.5385, hintTitle:'時間的警鐘', hintDesc:'為了紀念一位偉大的校長，這裡的鐘聲總是敲響21下。', hintImage:'images/bell.jpg', icon:'fa-bell', title:'聲速奧秘', desc:'分辨真假傅鐘的聲響，計算音速與時間差。', difficultyLabel:'物理數學', type:'physics' },
      gym: { id:'gym', name:'舊體育館', code:'D', lat:25.0222, lon:121.5369, hintTitle:'古典競技場', hintDesc:'校園中最古老的體育建築，門口的羅馬柱是其特徵。', hintImage:'images/gym.jpg', icon:'fa-dumbbell', title:'函數極值', desc:'彈道軌跡隱藏在古老的建築結構中。尋找三次函數的局部最低點。', difficultyLabel:'數學微積分', type:'math' },
      lake: { id:'lake', name:'醉月湖', code:'L', lat:25.0210, lon:121.5370, hintTitle:'詩人的倒影', hintDesc:'校園中的一抹碧波，湖心亭是其標誌。', hintImage:'images/lake.jpg', icon:'fa-water', title:'光學推演', desc:'分析場景中的物理條件（光源、反射介質），推導出李白觀測到的光學成像結果。', difficultyLabel:'物理文學', type:'literature' },
      library: { id:'library', name:'總圖書館', code:'C', lat:25.01734, lon:121.54056, hintTitle:'知識的堡壘', hintDesc:'校園的幾何中心，保存著百萬藏書的宏偉建築。', hintImage:'images/library.jpg', icon:'fa-book', title:'三角測量', desc:'利用俯角觀測數據，計算建築物的距離與高度。', difficultyLabel:'數學幾何', type:'math' },
      waffle: { id:'waffle', name:'小木屋', code:'0', lat:25.0195, lon:121.5408, hintTitle:'甜蜜的角落', hintDesc:'排隊人潮總是絡繹不絕，空氣中飄散著鬆餅的香氣。', hintImage:'images/waffle.jpg', icon:'fa-utensils', title:'音律食材', desc:'美味秘密藏在旋律裡。聆聽音符辨識音名，拼出英文食材單字。', difficultyLabel:'音樂聽寫', type:'music' },
      subway: { id:'subway', name:'公館捷運', code:'E', lat:25.0155, lon:121.5340, hintTitle:'地下的脈動', hintDesc:'校園旁的交通樞紐，四通八達的捷運路網。', hintImage:'images/subway.jpg', icon:'fa-train-subway', title:'捷運租屋', desc:'奎哥想在學校附近租屋。請協助他篩選符合通勤條件的捷運站。', difficultyLabel:'生活地理', type:'checkbox' }
    };

    const TEAM_ROUTES = {
      1: ['gate','palm','bell','gym','lake','library','waffle','subway'],
      2: ['bell','gym','lake','library','waffle','subway','gate','palm'],
      3: ['gym','lake','library','waffle','subway','gate','palm','bell'],
      4: ['subway','gate','palm','bell','gym','lake','library','waffle'],
      5: ['waffle','subway','gate','palm','bell','gym','lake','library'],
      6: ['library','waffle','subway','gate','palm','bell','gym','lake'],
      7: ['lake','library','waffle','subway','gate','palm','bell','gym'],
      8: ['palm','bell','gym','lake','library','waffle','subway','gate']
    };

    const app = {
      state: {
        teamId: null,
        completedStages: [],
        arrivedStages: [],
        stageScores: {}, stageStartTimes: {},
        currentView: 'intro',
        gateLockIndex: 0, gateLockSequence: []
      },

      audioCtx: null,
      noteFreqs: { C:261.63, D:293.66, E:329.63, F:349.23, G:392.00, A:440.00, B:493.88 },

      init() {
        try {
          this.loadProgress();
          this.render();
        } catch(e) {
          console.error(e);
          alert("Init Error: " + e);
        }
      },

      initAudio() {
        if(!this.audioCtx) this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if(this.audioCtx.state === 'suspended') this.audioCtx.resume();
      },

      playMelody(notes) {
        this.initAudio();
        const now = this.audioCtx.currentTime;
        notes.forEach((n, i) => {
          if(!this.noteFreqs[n]) return;
          const osc = this.audioCtx.createOscillator();
          const gain = this.audioCtx.createGain();
          osc.type = 'triangle';
          osc.frequency.value = this.noteFreqs[n];
          osc.connect(gain);
          gain.connect(this.audioCtx.destination);
          gain.gain.setValueAtTime(0, now + i * 0.6);
          gain.gain.linearRampToValueAtTime(0.3, now + i * 0.6 + 0.05);
          gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.6 + 0.5);
          osc.start(now + i * 0.6);
          osc.stop(now + i * 0.6 + 0.5);
        });
      },

      loadProgress() {
        const team = localStorage.getItem('ntu_puzzle_team');
        const c = localStorage.getItem('ntu_puzzle_completed');
        const a = localStorage.getItem('ntu_puzzle_arrived');

        if (team) {
          this.state.teamId = parseInt(team, 10);
          if (c) this.state.completedStages = JSON.parse(c);
          if (a) this.state.arrivedStages = JSON.parse(a);
          this.state.currentView = 'mission';
        }
      },

      saveProgress() {
        if(this.state.teamId) localStorage.setItem('ntu_puzzle_team', this.state.teamId);
        localStorage.setItem('ntu_puzzle_completed', JSON.stringify(this.state.completedStages));
        localStorage.setItem('ntu_puzzle_arrived', JSON.stringify(this.state.arrivedStages));
        this.updateUI();
      },

      updateUI() {
        if(this.state.teamId) {
          const el = document.getElementById('team-display');
          if(el) el.textContent = '小隊 ' + this.state.teamId;
        }
        ['mission','clues','final'].forEach(view => {
          const btn = document.getElementById('nav-' + view);
          if(btn) btn.classList.toggle('active', view === this.state.currentView);
        });
      },

      setTeam(id) {
        this.state.teamId = id;
        this.saveProgress();
        this.navigate('mission');
      },

      navigate(view) {
        this.state.currentView = view;
        this.state.gateLockIndex = 0;
        this.state.gateLockSequence = [];
        this.render();
      },

      resetGame() {
        if(confirm('確定要重置所有進度嗎？(將清除小隊設定)')) {
          localStorage.clear();
          location.reload();
        }
      },

      toast(msg) {
        const t = document.getElementById('toast');
        if(!t) return;
        document.getElementById('toast-msg').textContent = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
      },

      requestAdminSkip(id) {
        const code = prompt("輸入救援碼：");
        if (code === ADMIN_PASS) {
          this.forceArrive(id);
          this.toast("已強制解鎖");
        } else if(code !== null) {
          alert("密碼錯誤");
        }
      },

      render() {
        const container = document.getElementById('app-container');
        if(!container) return;
        container.innerHTML = '';
        this.updateUI();

        if (!this.state.teamId) {
          this.renderIntro(container);
          return;
        }

        if(this.state.currentView === 'intro') this.navigate('mission');
        else if(this.state.currentView === 'mission') this.renderMission(container);
        else if(this.state.currentView === 'clues') this.renderClues(container);
        else if(this.state.currentView === 'final') this.renderFinal(container);
      },

      renderIntro(container) {
        let buttons = '';
        for(let i=1; i<=8; i++) {
          buttons += `<button onclick="app.setTeam(${i})" class="btn-secondary" style="margin-bottom:10px;">小隊 0${i}</button>`;
        }
        container.innerHTML = `
          <div class="intro-container fade-in">
            <div class="logo-box">
              <img src="images/logo.png" onerror="this.src='https://via.placeholder.com/150?text=LOGO'">
            </div>
            <div class="mono" style="font-size:2rem; font-weight:bold; color:var(--accent-pink); letter-spacing:0.2em; text-shadow:0 0 10px rgba(217,70,239,0.5); margin-bottom:40px;">NTU ARCHIVE</div>
            <div class="w-full" style="max-width:300px;">
              <p style="color:var(--text-sub); margin-bottom:20px; font-size:0.9rem;">請選擇小隊編號</p>
              <div class="grid-2">${buttons}</div>
            </div>
          </div>`;
      },

      renderMission(container) {
        const route = TEAM_ROUTES[this.state.teamId];
        const currentIndex = this.state.completedStages.length;

        if (currentIndex >= route.length) {
          container.innerHTML = `
            <div class="intro-container fade-in">
              <div style="width:80px; height:80px; border-radius:50%; border:2px solid var(--accent-yellow); display:flex; align-items:center; justify-content:center; margin-bottom:20px;">
                <i class="fa-solid fa-flag-checkered" style="font-size:2rem; color:var(--accent-yellow)"></i>
              </div>
              <h2 style="font-size:1.5rem; margin-bottom:10px; color:white;">任務全數完成</h2>
              <p style="color:var(--text-sub); margin-bottom:30px;">請前往終端解碼</p>
              <button onclick="app.navigate('final')" class="btn-neon">前往終端機</button>
            </div>`;
          return;
        }

        const s = STAGES[route[currentIndex]];
        const isArrived = this.state.arrivedStages.includes(s.id);

        let content = `
          <div class="section-title">
            <div>
              <div class="mono" style="color:var(--accent-pink); font-size:0.7rem;">CURRENT_MISSION</div>
              <h2>任務 ${currentIndex + 1} / ${route.length}</h2>
            </div>
            <div style="font-size:0.7rem; color:var(--text-sub); border:1px solid var(--border-color); padding:4px 8px; border-radius:4px;">
              ${isArrived ? s.name : '地點加密'}
            </div>
          </div>`;

        if (!isArrived) {
          content += `
            <div class="card fade-in">
              <div style="margin-bottom:16px;">
                <h3 style="margin:0 0 10px 0; font-size:1.1rem; color:white;">${s.hintTitle}</h3>
                <div class="img-container">
                  <img src="${s.hintImage}" onerror="this.src='https://via.placeholder.com/400x200'" class="img-cover">
                </div>
                <p style="color:var(--text-sub); font-size:0.9rem; line-height:1.6;">${s.hintDesc}</p>
              </div>
              <div style="border-top:1px solid var(--border-color); padding-top:20px; text-align:center;">
                <button onclick="app.verifyLocation('${s.id}')" class="btn-neon">掃描目前位置</button>
                <div id="check-status" class="mono" style="color:var(--accent-yellow); font-size:0.7rem; margin-top:10px;"></div>
                <div class="mt-2">
                  <button onclick="app.requestAdminSkip('${s.id}')" style="background:none; border:none; color:var(--text-sub); font-size:0.7rem; cursor:pointer;" class="mono">定位異常？(輸入救援碼)</button>
                </div>
              </div>
            </div>`;
        } else {
          let puzzleHtml = '';
          if (s.id === 'gym') puzzleHtml = this.getGymPuzzle();
          // 其餘 puzzle 你原本的 function 可以照貼回來（略）

          content += `
            <div class="card fade-in">
              <div class="img-container">
                <img src="${s.hintImage}" class="img-cover">
              </div>
              <div style="color:var(--text-sub); font-size:0.9rem; margin-bottom:20px; line-height:1.6;">${s.desc}</div>
              ${puzzleHtml || '<div class="text-sub">（此段為示範，請把你其餘 puzzle function 貼回來）</div>'}
            </div>`;
        }

        container.innerHTML = content;
      },

      verifyLocation(id) {
        const s = STAGES[id];
        const stat = document.getElementById('check-status');
        if(stat) stat.textContent = "正在定位...";

        if (!navigator.geolocation) { if(stat) stat.textContent = "不支援 GPS"; return; }
        navigator.geolocation.getCurrentPosition(
          (p) => {
            const dist = this.getDist(p.coords.latitude, p.coords.longitude, s.lat, s.lon) * 1000;
            if (dist < 100) {
              if(stat) stat.textContent = "成功！";
              setTimeout(() => this.forceArrive(id), 1000);
            } else {
              if(stat) stat.textContent = "距離過遠 (" + Math.round(dist) + "m)";
              this.toast('位置太遠');
            }
          },
          () => { if(stat) stat.textContent = "GPS 失敗"; },
          { enableHighAccuracy: true }
        );
      },

      forceArrive(id) {
        if (!this.state.arrivedStages.includes(id)) {
          this.state.arrivedStages.push(id);
          this.saveProgress();
        }
        this.render();
      },

      highlightError(id) {
        const el = document.getElementById(id);
        if(el) {
          el.style.borderBottomColor = 'var(--danger)';
          setTimeout(() => el.style.borderBottomColor = 'var(--border-color)', 1000);
        }
      },

      checkAnswer(id, inp, ans) {
        const v = document.getElementById(inp).value.trim().toUpperCase();
        if (v === ans.toString()) this.completeStage(id);
        else { this.toast('答案錯誤'); this.highlightError(inp); }
      },

      completeStage(id) {
        if (!this.state.completedStages.includes(id)) {
          this.state.completedStages.push(id);
          this.saveProgress();
          alert("解鎖成功！");
        }
        this.render();
      },

      /* ✅ 小修：你題目寫「x>0 的局部極小值」，原本驗證 ans 是 -1 會永遠錯
         f'(x)=3x^2-3=0 => x=±1；x=1 才是 x>0 的極小點
         所以我把答案改成 1 */
      getGymPuzzle() {
        return `<div>
          <p style="color:var(--text-sub); font-size:0.9rem; margin-bottom:10px;">$f(x) = x^3 - 3x + 1$，求 x&gt;0 的局部極小值點 x？</p>
          <input type="text" id="ans-gym" placeholder="輸入 x" class="term-input">
          <button onclick="app.checkAnswer('gym', 'ans-gym', '1')" class="btn-neon" style="margin-top:10px;">驗證</button>
        </div>`;
      },

      renderClues(container){ container.innerHTML = `<div class="card">（略：請貼回你原本 renderClues）</div>`; },
      renderFinal(container){ container.innerHTML = `<div class="card">（略：請貼回你原本 renderFinal）</div>`; },

      getDist(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2-lat1)*(Math.PI/180);
        const dLon = (lon2-lon1)*(Math.PI/180);
        const a = Math.sin(dLat/2)*Math.sin(dLat/2) +
          Math.cos(lat1*(Math.PI/180))*Math.cos(lat2*(Math.PI/180)) *
          Math.sin(dLon/2)*Math.sin(dLon/2);
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
      }
    };

    window.onload = function() { app.init(); };
  </script>
</body>
</html>
