<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Project: NTU_LEGACY | 台大實境解謎</title>
    <!-- 設定網頁 Favicon -->
    <link rel="icon" type="image/png" href="images/logo.png">
    
    <!-- 引入字體與圖標 -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- 核心變數 (Cyberpunk Theme) --- */
        :root {
            --bg-color: #0b1121;
            --card-bg: #151e32;
            --border-color: #334155;
            --text-main: #e2e8f0;
            --text-sub: #94a3b8;
            --accent-cyan: #38bdf8;
            --accent-pink: #d946ef;
            --accent-yellow: #fbbf24;
            --danger: #ef4444;
            --success: #10b981;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Noto Sans TC', sans-serif;
            margin: 0; padding: 0;
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
            touch-action: manipulation;
        }

        /* --- 共用樣式 --- */
        .mono { font-family: 'JetBrains Mono', monospace; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- 背景特效 --- */
        .scanline {
            width: 100%; height: 100px; position: fixed; bottom: 100%; left: 0; z-index: 1; pointer-events: none;
            background: linear-gradient(0deg, rgba(0,0,0,0) 0%, rgba(56, 189, 248, 0.03) 50%, rgba(0,0,0,0) 100%);
            animation: scanline 8s linear infinite;
        }
        @keyframes scanline { 0% { bottom: 100%; } 100% { bottom: -100%; } }

        .neon-glow {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0;
            background: 
                radial-gradient(circle at 10% 20%, rgba(56, 189, 248, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(217, 70, 239, 0.05) 0%, transparent 40%);
        }

        /* --- Header --- */
        header {
            position: fixed; top: 0; left: 0; width: 100%; height: 60px;
            background: rgba(11, 17, 33, 0.95); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 16px; z-index: 50; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .header-logo { display: flex; align-items: center; gap: 8px; font-weight: bold; }
        .header-logo span:first-child { color: var(--accent-pink); font-size: 1.2rem; }
        .header-controls { display: flex; align-items: center; gap: 12px; font-size: 0.8rem; }
        .team-badge { background: rgba(217, 70, 239, 0.1); color: var(--accent-pink); padding: 4px 8px; border-radius: 4px; font-weight: bold; font-family: 'JetBrains Mono', monospace;}
        .reset-btn { background: none; border: none; color: var(--danger); cursor: pointer; display: flex; align-items: center; gap: 4px; font-size: 0.8rem; }

        /* --- Main --- */
        main {
            flex: 1; width: 100%; max-width: 480px; margin: 0 auto;
            padding: 80px 16px 120px 16px;
            overflow-y: auto; position: relative; z-index: 10;
        }

        /* --- Nav --- */
        nav {
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 100%; max-width: 480px; height: 70px;
            background: var(--bg-color); border-top: 1px solid var(--border-color);
            display: grid; grid-template-columns: 1fr 1fr 1fr;
            z-index: 50; box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }
        nav button {
            background: none; border: none; color: var(--text-sub);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 4px; font-size: 0.7rem; cursor: pointer; transition: color 0.3s;
        }
        nav button i { font-size: 1.4rem; margin-bottom: 2px; }
        nav button.active { color: var(--accent-pink); text-shadow: 0 0 10px rgba(217, 70, 239, 0.3); }

        /* --- Elements --- */
        .card {
            background: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 20px; margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            position: relative; overflow: hidden;
        }
        
        .btn-neon {
            width: 100%; padding: 14px;
            background: linear-gradient(90deg, #d946ef 0%, #7c3aed 100%);
            color: white; font-weight: bold; border: none; border-radius: 8px;
            font-size: 1rem; cursor: pointer;
            box-shadow: 0 0 15px rgba(217, 70, 239, 0.4);
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-neon:active { transform: scale(0.98); box-shadow: 0 0 5px rgba(217, 70, 239, 0.4); }

        .btn-secondary {
            width: 100%; padding: 12px;
            background: transparent; border: 1px solid var(--border-color);
            color: var(--text-sub); border-radius: 8px; font-weight: bold;
            cursor: pointer; transition: all 0.2s;
        }
        .btn-secondary:hover { border-color: var(--text-sub); color: white; }

        .input-field {
            width: 100%; background: rgba(0,0,0,0.2); border: none;
            border-bottom: 2px solid var(--border-color);
            color: var(--accent-pink); font-size: 1.5rem; text-align: center;
            padding: 10px; outline: none; font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase; letter-spacing: 2px; transition: all 0.3s;
        }
        .input-field:focus { border-bottom-color: var(--accent-pink); background: rgba(217, 70, 239, 0.05); }

        .section-title {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 16px; border-left: 4px solid var(--accent-pink); padding-left: 12px;
        }
        .section-title h2 { margin: 0; font-size: 1.2rem; color: white; }

        .img-container {
            width: 100%; height: 200px; border-radius: 8px; overflow: hidden;
            border: 1px solid var(--border-color); margin-bottom: 16px; background: #000;
        }
        .img-cover { width: 100%; height: 100%; object-fit: cover; }

        /* Toast */
        #toast {
            position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
            background: #1e293b; border: 1px solid var(--accent-pink); color: white;
            padding: 12px 24px; border-radius: 8px; z-index: 100;
            opacity: 0; transition: opacity 0.3s; pointer-events: none;
            display: flex; align-items: center; gap: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        #toast.show { opacity: 1; }

        /* Grid Helpers */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .flex-center { display: flex; align-items: center; justify-content: center; }

        /* Dial Puzzle Specific */
        .dial-wrapper {
            position: relative; width: 260px; height: 260px; margin: 20px auto;
            border-radius: 50%; background: linear-gradient(145deg, #1a233a, #0f1623);
            border: 10px solid var(--border-color);
            box-shadow: inset 0 0 20px #000;
            user-select: none;
        }
        .dial-track {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 170px; height: 170px; border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.05); pointer-events: none;
        }
        .dial-knob {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 160px; height: 160px; border-radius: 50%;
            background: var(--card-bg); border: 1px solid #334155;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 10; cursor: grab;
        }
        .dial-knob:active { cursor: grabbing; border-color: var(--accent-pink); }
        .dial-pointer {
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0;
            border-left: 10px solid transparent; border-right: 10px solid transparent;
            border-bottom: 18px solid var(--accent-yellow);
        }
        .dial-letter {
            position: absolute; width: 30px; height: 30px;
            text-align: center; line-height: 30px; color: var(--text-sub);
            font-weight: bold; font-family: 'JetBrains Mono', monospace;
            pointer-events: none; transform-origin: center center;
        }

        /* Checkbox Custom */
        .checkbox-group label {
            display: flex; align-items: center; padding: 12px;
            background: rgba(0,0,0,0.2); border: 1px solid var(--border-color);
            border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;
        }
        .checkbox-group label:hover { border-color: var(--accent-cyan); background: rgba(56, 189, 248, 0.1); }
        .checkbox-group input { margin-right: 12px; width: 18px; height: 18px; accent-color: var(--accent-cyan); }
    </style>
</head>
<body>

    <div class="scanline"></div>
    <div class="neon-glow"></div>

    <!-- Header -->
    <header>
        <div class="header-logo">
            <span>&gt;_</span>
            <span class="mono" style="color:white; letter-spacing: 2px;">NTU_SYSTEM</span>
        </div>
        <div class="header-controls">
            <div id="team-display" class="team-badge"></div>
            <button onclick="app.resetGame()" class="reset-btn">
                <i class="fa-solid fa-triangle-exclamation"></i> 重置
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main id="app-container"></main>

    <!-- Navigation -->
    <nav>
        <button onclick="app.navigate('mission')" id="nav-mission">
            <i class="fa-solid fa-location-arrow"></i> <span class="mono">當前任務</span>
        </button>
        <button onclick="app.navigate('clues')" id="nav-clues">
            <i class="fa-solid fa-key"></i> <span class="mono">金鑰碎片</span>
        </button>
        <button onclick="app.navigate('final')" id="nav-final">
            <i class="fa-solid fa-lock"></i> <span class="mono">終端解碼</span>
        </button>
    </nav>

    <!-- Toast Notification -->
    <div id="toast">
        <i class="fa-solid fa-circle-info"></i> <span id="toast-msg">Message</span>
    </div>

    <script>
        const ADMIN_PASS = '8888';

        const STAGES = {
            'gate': {
                id: 'gate', name: '台大校門', code: '2',
                lat: 25.017400, lon: 121.533900, 
                hintTitle: '知識的入口',
                hintDesc: '所有旅程的起點，昔日的帝國大學門戶。',
                hintImage: 'images/gate.jpg',
                icon: 'fa-torii-gate', title: '時光刻度',
                desc: '請轉動圓盤，依發生年代將校史事件排序。',
                difficultyLabel: '歷史排序', type: 'lock'
            },
            'palm': {
                id: 'palm', name: '椰林大道', code: '2', 
                lat: 25.018500, lon: 121.539000, 
                hintTitle: '熱帶的守望者',
                hintDesc: '筆直的大道，兩旁高聳的植物見證了無數學子的來去。',
                hintImage: 'images/palm.jpg',
                icon: 'fa-tree', title: '光譜密碼',
                desc: '尋找隱藏在椰林光影中的「台大紅」。請根據數學線索調配出正確的 RGB 數值。',
                difficultyLabel: '色彩數學', type: 'color'
            },
            'bell': {
                id: 'bell', name: '傅鐘', code: '2',
                lat: 25.018000, lon: 121.538500, 
                hintTitle: '時間的警鐘',
                hintDesc: '為了紀念一位偉大的校長，這裡的鐘聲總是敲響21下。',
                hintImage: 'images/bell.jpg',
                icon: 'fa-bell', title: '聲速奧秘',
                desc: '分辨真假傅鐘的聲響，計算音速與時間差。',
                difficultyLabel: '物理數學', type: 'physics'
            },
            'gym': {
                id: 'gym', name: '舊體育館', code: 'D',
                lat: 25.022200, lon: 121.536900, 
                hintTitle: '古典競技場',
                hintDesc: '校園中最古老的體育建築，門口的羅馬柱是其特徵。',
                hintImage: 'images/gym.jpg',
                icon: 'fa-dumbbell', title: '函數極值',
                desc: '彈道軌跡隱藏在古老的建築結構中。尋找三次函數的局部最低點。',
                difficultyLabel: '數學微積分', type: 'math'
            },
            'lake': {
                id: 'lake', name: '醉月湖', code: 'L',
                lat: 25.021000, lon: 121.537000, 
                hintTitle: '詩人的倒影',
                hintDesc: '校園中的一抹碧波，湖心亭是其標誌。',
                hintImage: 'images/lake.jpg',
                icon: 'fa-water', title: '光學推演', 
                desc: '分析場景中的物理條件（光源、反射介質），推導出李白觀測到的光學成像結果。',
                difficultyLabel: '物理文學', type: 'literature'
            },
            'library': {
                id: 'library', name: '總圖書館', code: 'C',
                lat: 25.017340, lon: 121.540560, 
                hintTitle: '知識的堡壘',
                hintDesc: '校園的幾何中心，保存著百萬藏書的宏偉建築。',
                hintImage: 'images/library.jpg',
                icon: 'fa-book', title: '三角測量',
                desc: '利用俯角觀測數據，計算建築物的距離與高度。',
                difficultyLabel: '數學幾何', type: 'math'
            },
            'waffle': {
                id: 'waffle', name: '小木屋', code: '0', 
                lat: 25.019500, lon: 121.540800, 
                hintTitle: '甜蜜的角落',
                hintDesc: '排隊人潮總是絡繹不絕，空氣中飄散著鬆餅的香氣。',
                hintImage: 'images/waffle.jpg',
                icon: 'fa-utensils', title: '音律食材',
                desc: '美味秘密藏在旋律裡。聆聽音符辨識音名，拼出英文食材單字。',
                difficultyLabel: '音樂聽寫', type: 'music'
            },
            'subway': {
                id: 'subway', name: '公館捷運', code: 'E',
                lat: 25.015500, lon: 121.534000, 
                hintTitle: '地下的脈動',
                hintDesc: '校園旁的交通樞紐，四通八達的捷運路網。',
                hintImage: 'images/subway.jpg',
                icon: 'fa-train-subway', title: '捷運租屋',
                desc: '奎哥想在學校附近租屋。請協助他篩選符合通勤條件的捷運站。',
                difficultyLabel: '生活地理', type: 'checkbox'
            }
        };

        const TEAM_ROUTES = {
            1: ['gate', 'palm', 'bell', 'gym', 'lake', 'library', 'waffle', 'subway'],
            2: ['bell', 'gym', 'lake', 'library', 'waffle', 'subway', 'gate', 'palm'],
            3: ['gym', 'lake', 'library', 'waffle', 'subway', 'gate', 'palm', 'bell'],
            4: ['subway', 'gate', 'palm', 'bell', 'gym', 'lake', 'library', 'waffle'],
            5: ['waffle', 'subway', 'gate', 'palm', 'bell', 'gym', 'lake', 'library'],
            6: ['library', 'waffle', 'subway', 'gate', 'palm', 'bell', 'gym', 'lake'],
            7: ['lake', 'library', 'waffle', 'subway', 'gate', 'palm', 'bell', 'gym'],
            8: ['palm', 'bell', 'gym', 'lake', 'library', 'waffle', 'subway', 'gate']
        };

        const FINAL_ANSWER_HASH = "REVMQ18yMDIy"; 

        const app = {
            state: {
                teamId: null,
                completedStages: [], arrivedStages: [],   
                stageScores: {}, stageStartTimes: {}, 
                currentView: 'intro', 
                gateLockIndex: 0, gateLockSequence: [] 
            },
            
            audioCtx: null,
            noteFreqs: { 'C': 261.63, 'D': 293.66, 'E': 329.63, 'F': 349.23, 'G': 392.00, 'A': 440.00, 'B': 493.88 },

            init() { 
                try {
                    this.loadProgress(); 
                    this.render(); 
                } catch(e) {
                    console.error(e);
                    alert("初始化失敗: " + e.message);
                }
            },

            initAudio() {
                if(!this.audioCtx) this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if(this.audioCtx.state === 'suspended') this.audioCtx.resume();
            },

            playMelody(notes) {
                this.initAudio();
                const now = this.audioCtx.currentTime;
                notes.forEach((n, i) => {
                    if(!this.noteFreqs[n]) return;
                    const osc = this.audioCtx.createOscillator();
                    const gain = this.audioCtx.createGain();
                    const t = now + i * 0.6;
                    osc.type = 'triangle';
                    osc.frequency.value = this.noteFreqs[n];
                    osc.connect(gain);
                    gain.connect(this.audioCtx.destination);
                    gain.gain.setValueAtTime(0, t);
                    gain.gain.linearRampToValueAtTime(0.3, t + 0.05);
                    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.5);
                    osc.start(t);
                    osc.stop(t + 0.5);
                });
            },

            loadProgress() {
                const team = localStorage.getItem('ntu_puzzle_team');
                const c = localStorage.getItem('ntu_puzzle_completed');
                const a = localStorage.getItem('ntu_puzzle_arrived');
                const s = localStorage.getItem('ntu_puzzle_scores');
                const t = localStorage.getItem('ntu_puzzle_start_times');
                
                if (team) {
                    this.state.teamId = parseInt(team);
                    if (c) this.state.completedStages = JSON.parse(c);
                    if (a) this.state.arrivedStages = JSON.parse(a);
                    if (s) this.state.stageScores = JSON.parse(s);
                    if (t) this.state.stageStartTimes = JSON.parse(t);
                    this.state.currentView = 'mission';
                }
            },

            saveProgress() {
                if(this.state.teamId) localStorage.setItem('ntu_puzzle_team', this.state.teamId);
                localStorage.setItem('ntu_puzzle_completed', JSON.stringify(this.state.completedStages));
                localStorage.setItem('ntu_puzzle_arrived', JSON.stringify(this.state.arrivedStages));
                localStorage.setItem('ntu_puzzle_scores', JSON.stringify(this.state.stageScores));
                localStorage.setItem('ntu_puzzle_start_times', JSON.stringify(this.state.stageStartTimes));
                this.updateUI(); 
            },
            
            updateUI() {
                if(this.state.teamId) {
                    const el = document.getElementById('team-display');
                    if(el) el.textContent = `小隊 ${this.state.teamId}`;
                }
                
                ['mission', 'clues', 'final'].forEach(view => {
                    const btn = document.getElementById(`nav-${view}`);
                    if(btn) {
                        if(view === this.state.currentView) btn.classList.add('active');
                        else btn.classList.remove('active');
                    }
                });
            },

            resetGame() {
                if(confirm('確定要重置所有進度嗎？(包含小隊設定)')) {
                    localStorage.clear();
                    location.reload();
                }
            },

            setTeam(id) {
                this.state.teamId = id;
                this.saveProgress();
                this.navigate('mission');
            },

            navigate(view) {
                this.state.currentView = view;
                this.state.gateLockIndex = 0; 
                this.state.gateLockSequence = [];
                this.render();
            },

            toast(msg) {
                const t = document.getElementById('toast');
                if(!t) return;
                document.getElementById('toast-msg').textContent = msg;
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 3000);
            },

            requestAdminSkip(id) {
                const code = prompt("請輸入救援密碼 (由管理員提供)：");
                if (code === ADMIN_PASS) {
                    this.forceArrive(id);
                    this.toast("已強制解鎖位置");
                } else if (code !== null) {
                    alert("密碼錯誤！");
                }
            },

            render() {
                const container = document.getElementById('app-container');
                if(!container) return;
                container.innerHTML = '';
                this.updateUI();
                
                if (!this.state.teamId) {
                    this.renderIntro(container);
                    return;
                }

                if(this.state.currentView === 'intro') this.navigate('mission'); 
                else if(this.state.currentView === 'mission') this.renderMission(container);
                else if(this.state.currentView === 'clues') this.renderClues(container);
                else if(this.state.currentView === 'final') this.renderFinal(container);
            },

            renderIntro(container) {
                let buttonsHtml = '';
                for(let i=1; i<=8; i++) {
                    buttonsHtml += `<button onclick="app.setTeam(${i})" class="btn-secondary" style="margin-bottom:10px;">小隊 0${i}</button>`;
                }

                container.innerHTML = `
                    <div class="intro-container fade-in">
                        <div class="logo-box">
                            <img src="images/logo.png" onerror="this.src='https://via.placeholder.com/150?text=LOGO'">
                        </div>
                        
                        <div class="title-main">NTU ARCHIVE</div>

                        <div class="w-full max-w-xs space-y-4">
                            <p class="text-sub mb-6">請選擇小隊編號以存取資料庫</p>
                            <div class="grid-2" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">${buttonsHtml}</div>
                        </div>
                    </div>`;
            },

            renderMission(container) {
                const route = TEAM_ROUTES[this.state.teamId];
                const currentIndex = this.state.completedStages.length;
                
                if (currentIndex >= route.length) {
                    container.innerHTML = `
                        <div class="intro-container fade-in">
                            <div style="width:80px; height:80px; border-radius:50%; border:2px solid var(--accent-yellow); display:flex; align-items:center; justify-content:center; margin-bottom:20px;">
                                <i class="fa-solid fa-flag-checkered text-4xl" style="color:var(--accent-yellow)"></i>
                            </div>
                            <h2 style="font-size:1.5rem; margin-bottom:10px;">任務全數完成</h2>
                            <p class="text-sub mb-8">所有資料碎片已收集完畢。<br>請前往終端解碼以完成任務。</p>
                            <button onclick="app.navigate('final')" class="btn-neon" style="width:auto; padding: 15px 40px;">
                                <i class="fa-solid fa-terminal"></i> 前往終端機
                            </button>
                        </div>
                    `;
                    return;
                }

                const currentStageId = route[currentIndex];
                const s = STAGES[currentStageId];
                const isArrived = this.state.arrivedStages.includes(currentStageId);

                let content = `
                    <div class="section-title">
                        <div>
                            <div class="mono" style="color:var(--accent-pink); font-size:0.7rem;">CURRENT_MISSION</div>
                            <h2>任務 ${currentIndex + 1} <span style="font-size:0.8rem; color:var(--text-sub)">/ ${route.length}</span></h2>
                        </div>
                        <div style="font-size:0.7rem; color:var(--text-sub); border:1px solid var(--border-color); padding:4px 8px; border-radius:4px; background:var(--bg-color);">
                            ${isArrived ? `<i class="fa-solid fa-location-dot" style="color:var(--accent-pink)"></i> ${s.name}` : '<i class="fa-solid fa-lock"></i> 地點加密'}
                        </div>
                    </div>
                `;

                if (!isArrived) {
                    content += `
                        <div class="card fade-in">
                            <div class="mb-4">
                                <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
                                    <i class="fa-solid fa-map-pin" style="color:var(--danger)"></i>
                                    <h3 style="margin:0; font-size:1.1rem;">${s.hintTitle}</h3>
                                </div>
                                <div class="img-container">
                                    <img src="${s.hintImage}" onerror="this.src='https://via.placeholder.com/400x200?text=Image+Not+Found'" class="img-cover">
                                </div>
                                <p style="color:var(--text-sub); font-size:0.9rem; line-height:1.6; border-left:2px solid var(--border-color); padding-left:12px;">${s.hintDesc}</p>
                            </div>
                            <div style="border-top:1px solid var(--border-color); padding-top:20px; text-align:center;">
                                <button onclick="app.verifyLocation('${s.id}')" class="btn-neon">
                                    <i class="fa-solid fa-satellite-dish"></i> 掃描目前位置
                                </button>
                                <div id="check-status" class="mono" style="color:var(--accent-yellow); font-size:0.7rem; margin-top:10px; min-height:1.5rem;"></div>
                                <div class="mt-2"><button onclick="app.requestAdminSkip('${s.id}')" style="background:none; border:none; color:var(--text-sub); font-size:0.7rem; cursor:pointer;" class="mono"><i class="fa-solid fa-triangle-exclamation"></i> 定位異常？(輸入救援碼)</button></div>
                            </div>
                        </div>`;
                } else {
                    let mediaHtml = '';
                    if (s.image) mediaHtml += `<div class="img-container"><img src="${s.image}" onerror="this.style.display='none'" class="img-cover"></div>`;

                    let puzzleHtml = '';
                    switch (s.id) {
                        case 'gym': puzzleHtml = this.getGymPuzzle(); break;
                        case 'subway': puzzleHtml = this.getSubwayPuzzle(); break;
                        case 'lake': puzzleHtml = this.getLakePuzzle(); break;
                        case 'library': puzzleHtml = this.getLibraryPuzzle(); break;
                        case 'waffle': puzzleHtml = this.getWafflePuzzle(); break;
                        case 'gate': puzzleHtml = this.getGatePuzzle(); break;
                        case 'bell': puzzleHtml = this.getBellPuzzle(); break;
                        case 'palm': puzzleHtml = this.getPalmPuzzle(); break;
                    }
                    content += `
                        <div class="card fade-in">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; border-bottom:1px solid var(--border-color); padding-bottom:12px;">
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <div style="width:32px; height:32px; background:var(--bg-color); border-radius:50%; display:flex; align-items:center; justify-content:center; border:1px solid var(--border-color); color:var(--accent-pink);"><i class="fa-solid ${s.icon}"></i></div>
                                    <span style="font-weight:bold; font-size:1.1rem;">${s.name}</span>
                                </div>
                                <span class="mono" style="font-size:0.6rem; padding:2px 6px; border-radius:4px; background:var(--bg-color); color:var(--text-sub); border:1px solid var(--border-color);">${s.difficultyLabel}</span>
                            </div>
                            <div style="color:var(--text-sub); font-size:0.9rem; margin-bottom:20px; line-height:1.6;">${s.desc}</div>
                            ${mediaHtml}
                            ${puzzleHtml}
                        </div>`;
                }
                container.innerHTML = content;
                if(isArrived) {
                    if(s.id === 'library') this.initLibraryEvents(); 
                    if(s.id === 'waffle') this.initWaffleEvents();
                    if(s.id === 'gate') this.initGateLock();
                    if(s.id === 'palm') this.initPalmEvents();
                }
            },

            verifyLocation(id) {
                const s = STAGES[id];
                const stat = document.getElementById('check-status');
                stat.textContent = "正在連線衛星進行三角定位...";
                stat.style.color = "var(--accent-cyan)";

                if (!navigator.geolocation) { stat.textContent = "錯誤：瀏覽器不支援 GPS"; return; }
                navigator.geolocation.getCurrentPosition(
                    (p) => {
                        const dist = this.getDist(p.coords.latitude, p.coords.longitude, s.lat, s.lon) * 1000;
                        if (dist < 100) {
                            stat.textContent = "訊號捕獲成功！正在解密...";
                            stat.style.color = "var(--success)";
                            setTimeout(() => this.forceArrive(id), 1500);
                        } else {
                            stat.textContent = `距離目標尚有 ${Math.round(dist)} 公尺`;
                            stat.style.color = "var(--danger)";
                            this.toast('位置太遠，請移動至目標地點');
                        }
                    },
                    (e) => { stat.textContent = "GPS 讀取失敗 (" + e.message + ")"; stat.style.color = "var(--danger)"; },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            },

            forceArrive(id) {
                if (!this.state.arrivedStages.includes(id)) {
                    this.state.arrivedStages.push(id);
                    if (!this.state.stageStartTimes[id]) this.state.stageStartTimes[id] = Date.now();
                    this.saveProgress();
                    this.toast('區域解鎖成功');
                }
                this.render();
            },

            /* --- PUZZLES --- */
            getPalmPuzzle() {
                return `
                    <div class="card mb-4" style="background:var(--bg-color);">
                        <div class="text-sub mb-4" style="border-left:2px solid var(--border-color); padding-left:12px;">
                            <p style="color:white; margin-bottom:8px; font-weight:bold;">光譜參數：</p>
                            <ul style="padding-left:20px; list-style-type:disc; font-size:0.8rem; line-height:1.5;">
                                <li>R (紅): <span style="color:var(--accent-pink)">椰林大道兩側各96顆椰子樹，共幾棵？</span></li>
                                <li>G (綠): <span style="color:var(--accent-pink)">第二個完全數 (Perfect Number)</span></li>
                                <li>B (藍): <span style="color:var(--accent-pink)">氧原子 (O) 的原子序平方</span></li>
                            </ul>
                        </div>
                        <div id="color-preview" style="width:100%; height:60px; border-radius:8px; margin-bottom:16px; border:1px solid var(--border-color); transition:background-color 0.3s; background-color:black;"></div>
                        <div style="display:flex; flex-direction:column; gap:12px;">
                            <div><div style="display:flex; justify-content:space-between; font-size:0.75rem; margin-bottom:4px; font-weight:bold;"><span style="color:#ef4444;">RED</span><span id="val-r" class="mono" style="color:#ef4444;">0</span></div><input type="range" id="range-r" min="0" max="255" value="0" style="width:100%;"></div>
                            <div><div style="display:flex; justify-content:space-between; font-size:0.75rem; margin-bottom:4px; font-weight:bold;"><span style="color:#10b981;">GREEN</span><span id="val-g" class="mono" style="color:#10b981;">0</span></div><input type="range" id="range-g" min="0" max="255" value="0" style="width:100%;"></div>
                            <div><div style="display:flex; justify-content:space-between; font-size:0.75rem; margin-bottom:4px; font-weight:bold;"><span style="color:#3b82f6;">BLUE</span><span id="val-b" class="mono" style="color:#3b82f6;">0</span></div><input type="range" id="range-b" min="0" max="255" value="0" style="width:100%;"></div>
                        </div>
                    </div><button onclick="app.checkPalm()" class="btn-neon">確認光譜</button>`;
            },
            initPalmEvents() {
                setTimeout(() => {
                    const r = document.getElementById('range-r'), g = document.getElementById('range-g'), b = document.getElementById('range-b');
                    if(!r) return;
                    const upd = () => { 
                        document.getElementById('color-preview').style.backgroundColor = `rgb(${r.value}, ${g.value}, ${b.value})`; 
                        document.getElementById('val-r').innerText = r.value; document.getElementById('val-g').innerText = g.value; document.getElementById('val-b').innerText = b.value;
                    };
                    [r, g, b].forEach(el => el.addEventListener('input', upd));
                }, 100);
            },
            checkPalm() {
                const r = document.getElementById('range-r').value, g = document.getElementById('range-g').value, b = document.getElementById('range-b').value;
                if (r == 192 && g == 28 && b == 64) this.completeStage('palm'); else this.toast('光譜頻率錯誤');
            },

            getGatePuzzle() {
                const letters = ['A','B','C','D','E','F','G']; let dialHtml = ''; const r = 110; const c = 128;
                letters.forEach((l, i) => {
                    const deg = i * (360/7); const rad = deg * (Math.PI/180);
                    const x = c + r * Math.sin(rad); const y = c - r * Math.cos(rad);
                    dialHtml += `<div class="dial-letter" style="left:${x}px; top:${y}px; transform: translate(-50%, -50%) rotate(${deg}deg);">${l}</div>`;
                });
                return `
                    <div style="user-select:none;">
                        <div style="background:var(--bg-color); border:1px solid var(--border-color); padding:12px; border-radius:8px; margin-bottom:24px; font-size:0.75rem; color:var(--text-sub); line-height:1.5;" class="mono">
                            <div><span class="text-accent">A.</span> 改為國立臺灣大學</div><div><span class="text-accent">B.</span> 校友獲得諾貝爾獎</div><div><span class="text-accent">C.</span> 這一年學生數為59人</div><div><span class="text-accent">D.</span> 舉辦首屆杜鵑花節</div><div><span class="text-accent">E.</span> 公布設立醫學部</div><div><span class="text-accent">F.</span> 成立國立臺灣大學聯盟</div><div><span class="text-accent">G.</span> 公布校歌</div>
                        </div>
                        <div class="dial-wrapper" id="dial-container">
                            <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:180px; height:180px; border-radius:50%; border:2px solid rgba(255,255,255,0.1); pointer-events:none;"></div>
                            ${dialHtml}
                            <div class="dial-knob" id="gate-knob">
                                <div class="dial-pointer"></div>
                                <div class="text-center">
                                    <div style="font-size:10px; color:var(--text-sub); letter-spacing:1px;">順序</div>
                                    <div style="font-size:2rem; font-weight:bold; color:white; font-family:monospace;" id="gate-seq-num">1</div>
                                </div>
                            </div>
                        </div>
                        <div class="grid-2 mb-4">
                            <button onclick="app.resetGateLock()" class="btn-secondary">重設</button>
                            <button onclick="app.confirmGateSelection()" class="btn-neon">確認鎖定</button>
                        </div>
                        <div class="grid-4" id="gate-progress" style="grid-template-columns: repeat(7, 1fr); background:var(--bg-color); padding:10px; border-radius:8px; border:1px solid var(--border-color);"></div>
                    </div>`;
            },
            initGateLock() {
                this.gateRotation = 0; this.isDragging = false; this.updateGateUI();
                const knob = document.getElementById('gate-knob'); const container = document.getElementById('dial-container');
                const start = (e) => { this.isDragging = true; e.preventDefault(); };
                const move = (e) => {
                    if (!this.isDragging) return; e.preventDefault();
                    const rect = container.getBoundingClientRect(); const cx = rect.left + rect.width / 2; const cy = rect.top + rect.height / 2;
                    const cx_t = e.touches ? e.touches[0].clientX : e.clientX; const cy_t = e.touches ? e.touches[0].clientY : e.clientY;
                    this.gateRotation = (Math.atan2(cy_t - cy, cx_t - cx) * (180 / Math.PI)) + 90;
                    document.getElementById('gate-knob').style.transform = `translate(-50%, -50%) rotate(${this.gateRotation}deg)`;
                };
                const end = (e) => {
                    if (!this.isDragging) return; this.isDragging = false;
                    const step = 360/7; let norm = this.gateRotation % 360; if(norm < 0) norm += 360;
                    this.gateRotation = Math.round(norm / step) * step;
                    const el = document.getElementById('gate-knob');
                    el.style.transition = 'transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                    el.style.transform = `translate(-50%, -50%) rotate(${this.gateRotation}deg)`;
                    setTimeout(() => { el.style.transition = 'none'; }, 300);
                };
                knob.addEventListener('mousedown', start); knob.addEventListener('touchstart', start);
                window.addEventListener('mousemove', move); window.addEventListener('touchmove', move, { passive: false });
                window.addEventListener('mouseup', end); window.addEventListener('touchend', end);
            },
            resetGateLock() { this.state.gateLockIndex = 0; this.state.gateLockSequence = []; this.gateRotation = 0; document.getElementById('gate-knob').style.transform = `translate(-50%, -50%) rotate(0deg)`; this.updateGateUI(); this.toast('密碼鎖已重置'); },
            confirmGateSelection() {
                const letters = ['A','B','C','D','E','F','G']; 
                let deg = this.gateRotation % 360; if (deg < 0) deg += 360;
                let index = Math.round(deg / (360/7)) % 7;
                this.state.gateLockSequence.push(letters[index]);
                this.state.gateLockIndex++;
                if (this.state.gateLockIndex < 7) { this.updateGateUI(); const k = document.getElementById('gate-knob'); k.style.borderColor = 'var(--accent-pink)'; setTimeout(() => k.style.borderColor = '#334155', 200); }
                else { if (this.state.gateLockSequence.join('') === 'CEAGBDF') this.completeStage('gate'); else { this.toast('排序錯誤，系統重置'); this.resetGateLock(); } }
            },
            updateGateUI() {
                const next = this.state.gateLockIndex + 1;
                if(document.getElementById('gate-seq-num')) document.getElementById('gate-seq-num').innerText = next > 7 ? 7 : next;
                const prog = document.getElementById('gate-progress');
                if(prog) {
                    prog.innerHTML = '';
                    for(let i=0; i<7; i++) {
                        const isLocked = i < this.state.gateLockIndex;
                        const cls = isLocked ? 'background:var(--accent-pink); color:white; border:1px solid var(--accent-pink);' : 'background:var(--card-bg); color:var(--text-sub); border:1px solid var(--border-color);';
                        prog.innerHTML += `<div style="aspect-ratio:1; display:flex; align-items:center; justify-content:center; border-radius:4px; font-weight:bold; font-size:1.2rem; font-family:monospace; ${cls}">${isLocked ? this.state.gateLockSequence[i] : '?'}</div>`;
                    }
                }
            },

            getWafflePuzzle() {
                return `<div class="text-center mb-6"><div style="display:inline-flex; width:64px; height:64px; border-radius:50%; background:var(--bg-color); border:1px solid var(--border-color); align-items:center; justify-content:center; margin-bottom:12px; box-shadow:0 0 10px rgba(0,0,0,0.3);"><i class="fa-solid fa-music" style="color:var(--accent-pink); font-size:1.5rem;"></i></div><p class="text-sub">點擊播放按鈕，聆聽旋律中的音符（例如 Do=C），拼出對應的英文單字。</p></div><div class="mb-6" style="display:flex; flex-direction:column; gap:12px;">${['E,G,G','B,E,E,F','C,A,B,B,A,G,E'].map((n, i) => `<div style="background:var(--bg-color); border:1px solid var(--border-color); padding:12px; border-radius:8px; display:flex; align-items:center; gap:12px;"><span class="mono" style="color:var(--accent-pink); font-weight:bold;">Q${i+1}</span><button onclick="app.playMelody(['${n.split(',').join("','")}'])" style="background:#7c3aed; color:white; border:none; width:30px; height:30px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;"><i class="fa-solid fa-play" style="font-size:0.7rem;"></i></button><input type="text" id="waffle-q${i+1}" class="input-field" placeholder="TYPE HERE"></div>`).join('')}</div><div style="display:flex; justify-content:center; margin-bottom:20px;"><button onclick="app.playMelody(['C'])" style="background:none; border:none; color:var(--text-sub); font-size:0.8rem; cursor:pointer;"><i class="fa-regular fa-circle-play"></i> 試聽基準音 C (Do)</button></div><button onclick="app.checkWaffle()" class="btn-neon">提交驗證</button>`;
            },
            initWaffleEvents() {},
            checkWaffle() {
                const ans = ['EGG','BEEF','CABBAGE']; let c = 0;
                ans.forEach((a, i) => { const el = document.getElementById(`waffle-q${i+1}`); if(el.value.trim().toUpperCase() === a) c++; else { el.style.borderBottomColor = 'var(--danger)'; setTimeout(() => el.style.borderBottomColor = 'var(--border-color)', 1000); } });
                if(c===3) this.completeStage('waffle'); else this.toast(`答對 ${c}/3 題`);
            },

            getBellPuzzle() {
                return `<div class="card text-center mb-4"><div class="custom-scrollbar" style="text-align:left; font-size:0.85rem; color:var(--text-sub); margin-bottom:20px; height:120px; overflow-y:auto; border-left:2px solid var(--border-color); padding-left:12px;"><p style="color:white; font-weight:bold; margin-bottom:8px;">事件紀錄：</p><ul style="list-style-type:disc; padding-left:20px; line-height:1.6;"><li>環境氣溫：<span class="text-accent">15°C</span></li><li>傅鐘：間隔 <span class="text-accent">3秒</span>，共 <span class="text-accent">21下</span></li><li>位置：距真傅鐘 <span class="text-accent">1700m</span></li><li>干擾：假喇叭在中間，距奎哥近 <span class="text-accent">200m</span> (1500m)</li><li>觀測：假鐘第一聲比真鐘早 <span class="text-accent">12秒</span></li></ul></div><div style="display:flex; flex-direction:column; gap:16px;"><div><label style="font-size:0.7rem; color:var(--text-sub); display:block; text-align:left; margin-bottom:4px;">Q1 音速 v (m/s)</label><input type="number" id="bell-q1" class="input-field"></div><div><label style="font-size:0.7rem; color:var(--text-sub); display:block; text-align:left; margin-bottom:4px;">Q2 假喇叭提早 (s)</label><input type="number" id="bell-q2" class="input-field"></div><div><label style="font-size:0.7rem; color:var(--text-sub); display:block; text-align:left; margin-bottom:4px;">Q3 真正遲到倒數 (s)</label><input type="number" id="bell-q3" class="input-field"></div></div></div><button onclick="app.checkBellAns()" class="btn-neon">提交驗證</button>`;
            },
            checkBellAns() {
                const q1 = document.getElementById('bell-q1').value.trim(), q2 = document.getElementById('bell-q2').value.trim(), q3 = document.getElementById('bell-q3').value.trim();
                let c = 0; if(q1 == '340') c++; else this.highlightError('bell-q1'); if(q2 == '11.4') c++; else this.highlightError('bell-q2'); if(q3 == '72') c++; else this.highlightError('bell-q3');
                if(c===3) this.completeStage('bell'); else this.toast(`答對 ${c}/3 題`);
            },

            getLibraryPuzzle() {
                return `<div class="card text-center mb-4"><div style="text-align:left; font-size:0.85rem; color:var(--text-sub); margin-bottom:20px; border-left:2px solid var(--border-color); padding-left:12px;"><p style="color:white; font-weight:bold; margin-bottom:8px;">觀測數據：</p><ul style="list-style-type:disc; padding-left:20px; line-height:1.6;"><li>觀測點：總圖書館樓頂</li><li>目標A (正西)：圖資系館 <span class="text-accent">俯角 10°</span></li><li>目標B (正南)：森林系館 <span class="text-accent">俯角 8°</span></li></ul><div style="margin-top:12px; background:rgba(255,255,255,0.05); padding:8px; border-radius:4px; font-size:0.7rem;"><i class="fa-brands fa-google"></i> 提示：利用 Google Maps 測量地標距離</div></div><div style="display:flex; flex-direction:column; gap:16px;"><div><label style="font-size:0.7rem; color:var(--text-sub); display:block; text-align:left; margin-bottom:4px;">Q1 AB系館距離 (m)</label><input type="number" id="lib-q1" class="input-field"></div><div><label style="font-size:0.7rem; color:var(--text-sub); display:block; text-align:left; margin-bottom:4px;">Q2 奎哥所在高度 (m)</label><input type="number" id="lib-q2" class="input-field"></div></div></div><button onclick="app.checkLibraryAns()" class="btn-neon">提交驗證</button>`;
            },
            initLibraryEvents() {},
            checkLibraryAns() {
                const q1 = document.getElementById('lib-q1').value.trim(), q2 = document.getElementById('lib-q2').value.trim();
                let c = 0; if(q1 == '90') c++; else this.highlightError('lib-q1'); if(q2 == '21') c++; else this.highlightError('lib-q2');
                if(c===2) this.completeStage('library'); else this.toast(`答對 ${c}/2 題`);
            },

            getSubwayPuzzle() {
                const opts = ['台北車站', '新店', '秀朗橋', '南勢角', '雙連', '忠孝復興', '龍山寺', '中和', '行天宮', '小碧潭'];
                let h = `<div class="card mb-4"><p class="text-sub" style="margin-bottom:16px; line-height:1.6;"><span class="text-accent" style="font-weight:bold;">租屋篩選條件：</span><br>1. 離學校(公館) 6 站捷運以內<br>2. 最多只需要換線 1 次</p><div class="grid-2">`;
                opts.forEach(o => h += `<label class="checkbox-group"><input type="checkbox" name="subway-opt" value="${o}"><span style="font-size:0.8rem; color:var(--text-main);">${o}</span></label>`);
                return h + `</div></div><button onclick="app.checkSubwayAns()" class="btn-neon">提交驗證</button>`;
            },
            checkSubwayAns() {
                const corr = ['台北車站', '新店', '秀朗橋', '南勢角', '龍山寺', '行天宮', '小碧潭'].sort();
                const chk = Array.from(document.querySelectorAll('input[name="subway-opt"]:checked')).map(e => e.value).sort();
                if(corr.length === chk.length && corr.every((v, i) => v === chk[i])) this.completeStage('subway'); else this.toast('選擇錯誤');
            },

            getLakePuzzle() {
                return `<div class="card text-center mb-4"><i class="fa-solid fa-moon" style="font-size:2rem; color:var(--accent-yellow); margin-bottom:16px; display:block;"></i><div style="text-align:left; font-size:0.85rem; color:var(--text-sub); margin-bottom:20px;"><p style="font-weight:bold; color:var(--accent-pink); margin-bottom:8px;">光學觀測實驗報告：</p><div style="background:var(--bg-color); padding:10px; border-radius:6px; border:1px solid var(--border-color); font-family:monospace; font-size:0.75rem; margin-bottom:12px;"><p>觀測者: 李白 (N=1)</p><p>光源: 明月</p><p>介質: 酒/地面</p><p>結果: 影子 + 像</p></div><p style="line-height:1.6; border-left:2px solid var(--border-color); padding-left:10px; margin-bottom:12px;">當光源照射物體，並經過介質反射後。觀測者聲稱系統中出現了<span class="text-accent">「三個實體」</span>。</p><p style="font-size:0.75rem;">請根據唐代學者李白的《光學觀測筆記》（原名：月下獨酌），輸入描述此物理現象結果的詩句（五個字）。</p></div><input type="text" id="ans-lake" placeholder="輸入五字詩句" class="input-field"></div><button onclick="app.checkAnswerText('lake', 'ans-lake', ['對影成三人'])" class="btn-neon">提交驗證</button>`;
            },
            getGymPuzzle() {
                return `<div class="card text-center mb-4"><p class="text-sub" style="text-align:left; margin-bottom:16px;">修正方程式：$f(x) = x^3 - 3x + 1$。請計算此函數在 $x > 0$ 區域內的局部極小值是多少？</p><input type="text" id="ans-gym" placeholder="輸入數值" class="input-field"></div><button onclick="app.checkAnswer('gym', 'ans-gym', '-1')" class="btn-neon">提交驗證</button>`;
            },

            highlightError(id) { const el = document.getElementById(id); el.style.borderBottomColor = 'var(--danger)'; setTimeout(()=>el.style.borderBottomColor = 'var(--border-color)', 1000); },
            checkAnswer(id, inp, ans) { const v = document.getElementById(inp).value.trim().toUpperCase(); if (v === ans.toString()) this.completeStage(id); else { this.toast('答案錯誤'); this.highlightError(inp); } },
            checkAnswerText(id, inp, anss) { const v = document.getElementById(inp).value.trim(); if (anss.includes(v)) this.completeStage(id); else { this.toast('答案錯誤'); this.highlightError(inp); } },
            completeStage(id) {
                if (!this.state.completedStages.includes(id)) {
                    this.state.completedStages.push(id); this.saveProgress();
                    const c = STAGES[id].code;
                    document.getElementById('app-container').innerHTML = `<div class="intro-container fade-in"><div style="width:80px; height:80px; border-radius:50%; background:var(--card-bg); border:1px solid var(--accent-pink); display:flex; align-items:center; justify-content:center; margin-bottom:20px; box-shadow:0 0 20px rgba(217,70,239,0.3);"><i class="fa-solid fa-unlock" style="font-size:2rem; color:white;"></i></div><div class="mono" style="color:var(--accent-pink); font-size:0.8rem; letter-spacing:2px; margin-bottom:8px;">SYSTEM_UNLOCKED</div><h2 style="font-size:1.8rem; font-weight:bold; color:white; margin-bottom:20px;">解鎖成功</h2><div style="background:var(--bg-color); border:1px solid var(--border-color); padding:20px; border-radius:8px; margin-bottom:30px;"><div style="font-size:0.75rem; color:var(--text-sub); margin-bottom:8px;">獲得金鑰碎片</div><div class="mono" style="font-size:2.5rem; font-weight:bold; color:white;">${c}</div></div><button onclick="app.navigate('mission')" class="btn-secondary">前往下一站</button></div>`;
                } else this.render();
            },
            renderClues(container) {
                const route = TEAM_ROUTES[this.state.teamId];
                let html = `<div class="section-title"><h2>資料庫碎片</h2><span class="mono" style="font-size:0.7rem; color:var(--text-sub);">DB_STATUS: ${this.state.completedStages.length}/${route.length}</span></div><div class="grid-2">`;
                route.forEach(k => {
                    const s = STAGES[k]; const u = this.state.completedStages.includes(k);
                    html += `<div class="card" style="aspect-ratio:1; display:flex; flex-direction:column; align-items:center; justify-content:center; margin:0; padding:0; border-color:${u?'var(--accent-pink)':'var(--border-color)'}; box-shadow:${u?'0 0 10px rgba(217,70,239,0.2)':'none'};">${u ? `<span class="mono" style="font-size:2.5rem; font-weight:bold; color:var(--accent-pink); margin-bottom:8px;">${s.code}</span><span style="font-size:0.7rem; color:var(--text-sub);">${s.name}</span>` : `<i class="fa-solid fa-lock" style="font-size:1.5rem; color:var(--border-color); margin-bottom:8px;"></i><span class="mono" style="font-size:0.7rem; color:var(--border-color);">LOCKED</span>`}</div>`;
                });
                container.innerHTML = html + `</div>`;
            },
            renderFinal(container) {
                const ok = this.state.completedStages.length === TEAM_ROUTES[this.state.teamId].length;
                container.innerHTML = `<div class="section-title" style="border-left-color:var(--danger);"><h2>終端核心</h2><span class="mono" style="font-size:0.7rem; color:var(--danger);">ACCESS_LEVEL: ADMIN</span></div><div class="card text-center" style="padding:30px;"><div style="margin-bottom:20px; display:inline-block;"><i class="fa-solid fa-shield-halved" style="font-size:3rem; color:${ok? 'var(--danger)':'var(--border-color)'};"></i></div><p class="text-sub mb-4">請輸入完整的「智慧之鑰」代碼以解鎖系統核心。</p><div style="display:flex; justify-content:center; gap:8px; margin-bottom:24px;"><input type="text" id="final-part1" class="input-field" style="width:80px;" maxlength="4" ${!ok?'disabled':''}><span class="mono" style="font-size:1.5rem; color:var(--text-sub);">_</span><input type="text" id="final-part2" class="input-field" style="width:80px;" maxlength="4" ${!ok?'disabled':''}></div>${!ok ? `<div style="font-size:0.75rem; color:var(--danger); background:rgba(239,68,68,0.1); padding:8px; border-radius:4px; border:1px solid rgba(239,68,68,0.2);"><i class="fa-solid fa-lock"></i> 存取被拒：需先完成所有任務</div>` : `<button onclick="app.checkFinal()" class="btn-neon" style="background:var(--danger); box-shadow:0 0 15px rgba(239,68,68,0.4);">執行解密程序</button>`}</div>`;
            },
            checkFinal() {
                try {
                    const p1 = document.getElementById('final-part1').value.trim().toUpperCase(); const p2 = document.getElementById('final-part2').value.trim().toUpperCase(); const input = `${p1}_${p2}`;
                    if (btoa(input) === FINAL_ANSWER_HASH) {
                        const container = document.getElementById('app-container');
                        container.innerHTML = `<div class="intro-container fade-in"><div style="width:100%; max-width:320px; background:var(--bg-color); border:2px solid var(--success); border-radius:12px; padding:30px; text-align:center; box-shadow:0 0 30px rgba(16,185,129,0.2);"><div style="width:60px; height:60px; background:var(--success); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px auto;"><i class="fa-solid fa-check" style="font-size:1.5rem; color:var(--bg-color);"></i></div><h2 style="font-size:1.5rem; font-weight:bold; color:white; margin-bottom:10px; letter-spacing:1px;">ACCESS GRANTED</h2><div style="font-size:0.9rem; color:var(--text-sub); margin-bottom:24px; line-height:1.5;"><p>恭喜獲得智慧之鑰！</p><p>請截圖此畫面領取獎勵。</p></div><div style="height:1px; background:rgba(16,185,129,0.3); width:100%; margin-bottom:20px;"></div><div class="mono" style="color:var(--success); font-size:0.8rem; letter-spacing:2px;">HASH: ${Date.now().toString(16).toUpperCase()}</div></div></div>`;
                        this.toast('解密成功！');
                    } else { this.toast('代碼錯誤 (ACCESS DENIED)'); }
                } catch(e) { this.toast('格式錯誤'); }
            },
            getDist(lat1, lon1, lat2, lon2) {
                const R = 6371; const dLat = (lat2-lat1)*(Math.PI/180); const dLon = (lon2-lon1)*(Math.PI/180);
                const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*(Math.PI/180))*Math.cos(lat2*(Math.PI/180)) * Math.sin(dLon/2)*Math.sin(dLon/2);
                return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
            }
        };

        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
