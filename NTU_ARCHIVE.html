<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Project: NTU_LEGACY | 台大實境解謎</title>
    <link rel="icon" type="image/png" href="images/logo.png">

    <!-- [除錯工具] 如果有錯誤，會在頁面上方顯示紅框 -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            var errorBox = document.createElement('div');
            errorBox.style.cssText = 'position:fixed;top:0;left:0;width:100%;background:red;color:white;z-index:99999;padding:10px;font-family:monospace;font-size:14px;word-break:break-all;';
            errorBox.innerHTML = '<strong>SYSTEM ERROR:</strong> ' + message + ' (Line: ' + lineno + ')';
            document.body.appendChild(errorBox);
            return false;
        };
    </script>
    
    <!-- 引入字體與圖標 -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- 核心變數 --- */
        :root {
            --bg-color: #0b1121;
            --card-bg: #151e32;
            --border-color: #334155;
            --text-main: #e2e8f0;
            --text-sub: #94a3b8;
            --accent-cyan: #38bdf8;
            --accent-pink: #d946ef;
            --accent-yellow: #fbbf24;
            --danger: #ef4444;
            --success: #10b981;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Noto Sans TC', sans-serif;
            margin: 0; padding: 0;
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
            touch-action: manipulation;
        }

        /* --- 工具類別 --- */
        .mono { font-family: 'JetBrains Mono', monospace; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- 背景特效 --- */
        .scanline {
            width: 100%; height: 100px; position: fixed; bottom: 100%; left: 0; z-index: 1; pointer-events: none;
            background: linear-gradient(0deg, rgba(0,0,0,0) 0%, rgba(56, 189, 248, 0.03) 50%, rgba(0,0,0,0) 100%);
            animation: scanline 8s linear infinite;
        }
        @keyframes scanline { 0% { bottom: 100%; } 100% { bottom: -100%; } }

        .neon-glow {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0;
            background: 
                radial-gradient(circle at 10% 20%, rgba(56, 189, 248, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(217, 70, 239, 0.05) 0%, transparent 40%);
        }

        /* --- Header --- */
        header {
            position: fixed; top: 0; left: 0; width: 100%; height: 60px;
            background: rgba(11, 17, 33, 0.95); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 16px; z-index: 50; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .header-logo { display: flex; align-items: center; gap: 8px; font-weight: bold; }
        .header-logo span:first-child { color: var(--accent-pink); font-size: 1.2rem; }
        .header-controls { display: flex; align-items: center; gap: 12px; font-size: 0.8rem; }
        .team-badge { background: rgba(217, 70, 239, 0.1); color: var(--accent-pink); padding: 4px 8px; border-radius: 4px; font-weight: bold; font-family: 'JetBrains Mono', monospace;}
        .reset-btn { background: none; border: none; color: var(--danger); cursor: pointer; display: flex; align-items: center; gap: 4px; font-size: 0.8rem; }

        /* --- Main Content --- */
        main {
            flex: 1; width: 100%; max-width: 480px; margin: 0 auto;
            padding: 80px 16px 120px 16px;
            overflow-y: auto; position: relative; z-index: 10;
        }

        /* --- Navigation --- */
        nav {
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 100%; max-width: 480px; height: 70px;
            background: var(--bg-color); border-top: 1px solid var(--border-color);
            display: grid; grid-template-columns: 1fr 1fr 1fr;
            z-index: 50; box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }
        nav button {
            background: none; border: none; color: var(--text-sub);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 4px; font-size: 0.7rem; cursor: pointer; transition: color 0.3s;
        }
        nav button i { font-size: 1.4rem; margin-bottom: 2px; }
        nav button.active { color: var(--accent-pink); text-shadow: 0 0 10px rgba(217, 70, 239, 0.3); }

        /* --- UI Components --- */
        .card {
            background: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 20px; margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            position: relative; overflow: hidden;
        }
        
        .btn-neon {
            width: 100%; padding: 14px;
            background: linear-gradient(90deg, #d946ef 0%, #7c3aed 100%);
            color: white; font-weight: bold; border: none; border-radius: 8px;
            font-size: 1rem; cursor: pointer;
            box-shadow: 0 0 15px rgba(217, 70, 239, 0.4);
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-neon:active { transform: scale(0.98); box-shadow: 0 0 5px rgba(217, 70, 239, 0.4); }

        .btn-secondary {
            width: 100%; padding: 12px;
            background: transparent; border: 1px solid var(--border-color);
            color: var(--text-sub); border-radius: 8px; font-weight: bold;
            cursor: pointer; transition: all 0.2s;
        }
        .btn-secondary:hover { border-color: var(--text-sub); color: white; }

        .input-field {
            width: 100%; background: rgba(0,0,0,0.2); border: none;
            border-bottom: 2px solid var(--border-color);
            color: var(--accent-pink); font-size: 1.5rem; text-align: center;
            padding: 10px; outline: none; font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase; letter-spacing: 2px; transition: all 0.3s;
        }
        .input-field:focus { border-bottom-color: var(--accent-pink); background: rgba(217, 70, 239, 0.05); }

        .section-title {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 16px; border-left: 4px solid var(--accent-pink); padding-left: 12px;
        }
        .section-title h2 { margin: 0; font-size: 1.2rem; color: white; }

        .img-container {
            width: 100%; height: 200px; border-radius: 8px; overflow: hidden;
            border: 1px solid var(--border-color); margin-bottom: 16px; background: #000;
        }
        .img-cover { width: 100%; height: 100%; object-fit: cover; }

        /* Toast */
        #toast {
            position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
            background: #1e293b; border: 1px solid var(--accent-pink); color: white;
            padding: 12px 24px; border-radius: 8px; z-index: 100;
            opacity: 0; transition: opacity 0.3s; pointer-events: none;
            display: flex; align-items: center; gap: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        #toast.show { opacity: 1; }

        /* Grid Helpers */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }

        /* Dial Puzzle Specific */
        .dial-wrapper {
            position: relative; width: 260px; height: 260px; margin: 20px auto;
            border-radius: 50%; background: linear-gradient(145deg, #1a233a, #0f1623);
            border: 10px solid var(--border-color);
            box-shadow: inset 0 0 20px #000;
            user-select: none;
        }
        .dial-track {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 170px; height: 170px; border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.05); pointer-events: none;
        }
        .dial-knob {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 160px; height: 160px; border-radius: 50%;
            background: var(--card-bg); border: 1px solid #334155;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 10; cursor: grab;
        }
        .dial-knob:active { cursor: grabbing; border-color: var(--accent-pink); }
        .dial-pointer {
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0;
            border-left: 10px solid transparent; border-right: 10px solid transparent;
            border-bottom: 18px solid var(--accent-yellow);
        }
        .dial-letter {
            position: absolute; width: 30px; height: 30px;
            text-align: center; line-height: 30px; color: var(--text-sub);
            font-weight: bold; font-family: 'JetBrains Mono', monospace;
            pointer-events: none; transform-origin: center center;
        }

        /* Checkbox Custom */
        .checkbox-group label {
            display: flex; align-items: center; padding: 12px;
            background: rgba(0,0,0,0.2); border: 1px solid var(--border-color);
            border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;
        }
        .checkbox-group label:hover { border-color: var(--accent-cyan); background: rgba(56, 189, 248, 0.1); }
        .checkbox-group input { margin-right: 12px; width: 18px; height: 18px; accent-color: var(--accent-cyan); }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 2px; }
    </style>
</head>
<body>

    <div class="scanline"></div>
    <div class="neon-glow"></div>

    <!-- Header -->
    <header>
        <div class="header-logo">
            <span>&gt;_</span>
            <span class="mono" style="color:#d946ef; letter-spacing: 2px;">NTU_SYSTEM</span>
        </div>
        <div class="header-controls">
            <div id="team-display" class="team-badge"></div>
            <button onclick="app.resetGame()" class="reset-btn">
                <i class="fa-solid fa-triangle-exclamation"></i> 重置
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main id="app-container"></main>

    <!-- Navigation -->
    <nav>
        <button onclick="app.navigate('mission')" id="nav-mission">
            <i class="fa-solid fa-location-arrow"></i> <span class="mono">當前任務</span>
        </button>
        <button onclick="app.navigate('clues')" id="nav-clues">
            <i class="fa-solid fa-key"></i> <span class="mono">金鑰碎片</span>
        </button>
        <button onclick="app.navigate('final')" id="nav-final">
            <i class="fa-solid fa-lock"></i> <span class="mono">終端解碼</span>
        </button>
    </nav>

    <!-- Toast -->
    <div id="toast">
        <i class="fa-solid fa-circle-info"></i> <span id="toast-msg">Message</span>
    </div>

    <script>
        // 設定
        const ADMIN_PASS = '8888';
        const FINAL_ANSWER_HASH = "REVMQ18yMDIy"; 

        const STAGES = {
            'gate': {
                id: 'gate', name: '台大校門', code: '2',
                lat: 25.017400, lon: 121.533900, 
                hintTitle: '知識的入口',
                hintDesc: '所有旅程的起點，昔日的帝國大學門戶。',
                hintImage: 'images/gate.jpg',
                icon: 'fa-torii-gate', title: '時光刻度',
                desc: '請轉動圓盤，依發生年代將校史事件排序。',
                difficultyLabel: '歷史排序', type: 'lock'
            },
            'palm': {
                id: 'palm', name: '椰林大道', code: '2', 
                lat: 25.018500, lon: 121.539000, 
                hintTitle: '熱帶的守望者',
                hintDesc: '筆直的大道，兩旁高聳的植物見證了無數學子的來去。',
                hintImage: 'images/palm.jpg',
                icon: 'fa-tree', title: '光譜密碼',
                desc: '尋找隱藏在椰林光影中的「台大紅」。請根據數學線索調配出正確的 RGB 數值。',
                difficultyLabel: '色彩數學', type: 'color'
            },
            'bell': {
                id: 'bell', name: '傅鐘', code: '2',
                lat: 25.018000, lon: 121.538500, 
                hintTitle: '時間的警鐘',
                hintDesc: '為了紀念一位偉大的校長，這裡的鐘聲總是敲響21下。',
                hintImage: 'images/bell.jpg',
                icon: 'fa-bell', title: '聲速奧秘',
                desc: '分辨真假傅鐘的聲響，計算音速與時間差。',
                difficultyLabel: '物理數學', type: 'physics'
            },
            'gym': {
                id: 'gym', name: '舊體育館', code: 'D',
                lat: 25.022200, lon: 121.536900, 
                hintTitle: '古典競技場',
                hintDesc: '校園中最古老的體育建築，門口的羅馬柱是其特徵。',
                hintImage: 'images/gym.jpg',
                icon: 'fa-dumbbell', title: '函數極值',
                desc: '彈道軌跡隱藏在古老的建築結構中。尋找三次函數的局部最低點。',
                difficultyLabel: '數學微積分', type: 'math'
            },
            'lake': {
                id: 'lake', name: '醉月湖', code: 'L',
                lat: 25.021000, lon: 121.537000, 
                hintTitle: '詩人的倒影',
                hintDesc: '校園中的一抹碧波，湖心亭是其標誌。',
                hintImage: 'images/lake.jpg',
                icon: 'fa-water', title: '光學推演', 
                desc: '分析場景中的物理條件（光源、反射介質），推導出李白觀測到的光學成像結果。',
                difficultyLabel: '物理文學', type: 'literature'
            },
            'library': {
                id: 'library', name: '總圖書館', code: 'C',
                lat: 25.017340, lon: 121.540560, 
                hintTitle: '知識的堡壘',
                hintDesc: '校園的幾何中心，保存著百萬藏書的宏偉建築。',
                hintImage: 'images/library.jpg',
                icon: 'fa-book', title: '三角測量',
                desc: '利用俯角觀測數據，計算建築物的距離與高度。',
                difficultyLabel: '數學幾何', type: 'math'
            },
            'waffle': {
                id: 'waffle', name: '小木屋', code: '0', 
                lat: 25.019500, lon: 121.540800, 
                hintTitle: '甜蜜的角落',
                hintDesc: '排隊人潮總是絡繹不絕，空氣中飄散著鬆餅的香氣。',
                hintImage: 'images/waffle.jpg',
                icon: 'fa-utensils', title: '音律食材',
                desc: '美味秘密藏在旋律裡。聆聽音符辨識音名，拼出英文食材單字。',
                difficultyLabel: '音樂聽寫', type: 'music'
            },
            'subway': {
                id: 'subway', name: '公館捷運', code: 'E',
                lat: 25.015500, lon: 121.534000, 
                hintTitle: '地下的脈動',
                hintDesc: '校園旁的交通樞紐，四通八達的捷運路網。',
                hintImage: 'images/subway.jpg',
                icon: 'fa-train-subway', title: '捷運租屋',
                desc: '奎哥想在學校附近租屋。請協助他篩選符合通勤條件的捷運站。',
                difficultyLabel: '生活地理', type: 'checkbox'
            }
        };

        const TEAM_ROUTES = {
            1: ['gate', 'palm', 'bell', 'gym', 'lake', 'library', 'waffle', 'subway'],
            2: ['bell', 'gym', 'lake', 'library', 'waffle', 'subway', 'gate', 'palm'],
            3: ['gym', 'lake', 'library', 'waffle', 'subway', 'gate', 'palm', 'bell'],
            4: ['subway', 'gate', 'palm', 'bell', 'gym', 'lake', 'library', 'waffle'],
            5: ['waffle', 'subway', 'gate', 'palm', 'bell', 'gym', 'lake', 'library'],
            6: ['library', 'waffle', 'subway', 'gate', 'palm', 'bell', 'gym', 'lake'],
            7: ['lake', 'library', 'waffle', 'subway', 'gate', 'palm', 'bell', 'gym'],
            8: ['palm', 'bell', 'gym', 'lake', 'library', 'waffle', 'subway', 'gate']
        };

        const app = {
            state: {
                teamId: null,
                completedStages: [], arrivedStages: [],   
                stageScores: {}, stageStartTimes: {}, 
                currentView: 'intro', 
                gateLockIndex: 0, gateLockSequence: [] 
            },
            
            audioCtx: null,
            noteFreqs: { 'C': 261.63, 'D': 293.66, 'E': 329.63, 'F': 349.23, 'G': 392.00, 'A': 440.00, 'B': 493.88 },

            init() { 
                try {
                    this.loadProgress(); 
                    this.render(); 
                } catch(e) {
                    alert("Init Error: " + e);
                }
            },

            // 儲存與讀取
            loadProgress() {
                const team = localStorage.getItem('ntu_puzzle_team');
                const c = localStorage.getItem('ntu_puzzle_completed');
                const a = localStorage.getItem('ntu_puzzle_arrived');
                
                if (team) {
                    this.state.teamId = parseInt(team);
                    if (c) this.state.completedStages = JSON.parse(c);
                    if (a) this.state.arrivedStages = JSON.parse(a);
                    this.state.currentView = 'mission';
                }
            },
            saveProgress() {
                if(this.state.teamId) localStorage.setItem('ntu_puzzle_team', this.state.teamId);
                localStorage.setItem('ntu_puzzle_completed', JSON.stringify(this.state.completedStages));
                localStorage.setItem('ntu_puzzle_arrived', JSON.stringify(this.state.arrivedStages));
                this.updateUI(); 
            },
            
            updateUI() {
                if(this.state.teamId) {
                    const el = document.getElementById('team-display');
                    if(el) el.textContent = '小隊 ' + this.state.teamId;
                }
                
                ['mission', 'clues', 'final'].forEach(view => {
                    const btn = document.getElementById('nav-' + view);
                    if(btn) {
                        if(view === this.state.currentView) {
                            btn.classList.add('active');
                        } else {
                            btn.classList.remove('active');
                        }
                    }
                });
            },

            // 導航
            navigate(view) {
                this.state.currentView = view;
                this.state.gateLockIndex = 0; 
                this.state.gateLockSequence = [];
                this.render();
            },
            
            setTeam(id) {
                this.state.teamId = id;
                this.saveProgress();
                this.navigate('mission');
            },

            resetGame() {
                if(confirm('確定要重置所有進度嗎？')) {
                    localStorage.clear();
                    location.reload();
                }
            },

            // 核心渲染
            render() {
                const container = document.getElementById('app-container');
                if(!container) return;
                container.innerHTML = '';
                this.updateUI();
                
                if (!this.state.teamId) {
                    this.renderIntro(container);
                    return;
                }

                if(this.state.currentView === 'intro') this.navigate('mission'); 
                else if(this.state.currentView === 'mission') this.renderMission(container);
                else if(this.state.currentView === 'clues') this.renderClues(container);
                else if(this.state.currentView === 'final') this.renderFinal(container);
            },

            // Intro Page
            renderIntro(container) {
                let buttons = '';
                for(let i=1; i<=8; i++) {
                    buttons += '<button onclick="app.setTeam('+i+')" class="btn-secondary" style="margin-bottom:10px;">小隊 0'+i+'</button>';
                }
                container.innerHTML = `
                    <div class="intro-container fade-in">
                        <div class="logo-box">
                            <img src="images/logo.png" onerror="this.src='https://via.placeholder.com/150?text=LOGO'">
                        </div>
                        <div class="title-main">NTU ARCHIVE</div>
                        <div class="w-full max-w-xs space-y-4">
                            <p class="text-sub mb-6">請選擇小隊編號</p>
                            <div class="grid-2">${buttons}</div>
                        </div>
                    </div>`;
            },

            // Mission Page
            renderMission(container) {
                const route = TEAM_ROUTES[this.state.teamId];
                const currentIndex = this.state.completedStages.length;
                
                if (currentIndex >= route.length) {
                    container.innerHTML = `
                        <div class="intro-container fade-in">
                            <h2 style="font-size:1.5rem; margin-bottom:20px; color:white;">任務全數完成</h2>
                            <button onclick="app.navigate('final')" class="btn-neon">前往終端機</button>
                        </div>`;
                    return;
                }

                const s = STAGES[route[currentIndex]];
                const isArrived = this.state.arrivedStages.includes(s.id);
                
                let content = `
                    <div class="section-title">
                        <div>
                            <div class="mono" style="color:#d946ef; font-size:0.7rem;">CURRENT_MISSION</div>
                            <h2>任務 ${currentIndex + 1} / ${route.length}</h2>
                        </div>
                        <div style="font-size:0.7rem; color:#94a3b8; border:1px solid #334155; padding:4px 8px; border-radius:4px;">
                            ${isArrived ? s.name : '地點加密'}
                        </div>
                    </div>`;

                if (!isArrived) {
                    content += `
                        <div class="card fade-in">
                            <div class="mb-4">
                                <h3 style="margin:0 0 10px 0; font-size:1.1rem; color:white;">${s.hintTitle}</h3>
                                <div class="img-container">
                                    <img src="${s.hintImage}" onerror="this.src='https://via.placeholder.com/400x200'" class="img-cover">
                                </div>
                                <p style="color:#94a3b8; font-size:0.9rem;">${s.hintDesc}</p>
                            </div>
                            <div style="border-top:1px solid #334155; padding-top:20px; text-align:center;">
                                <button onclick="app.verifyLocation('${s.id}')" class="btn-neon">掃描目前位置</button>
                                <div id="check-status" class="mono" style="color:#fbbf24; font-size:0.7rem; margin-top:10px;"></div>
                                <div class="mt-2"><button onclick="app.requestAdminSkip('${s.id}')" style="background:none; border:none; color:#94a3b8; cursor:pointer;" class="mono">定位異常？(輸入救援碼)</button></div>
                            </div>
                        </div>`;
                } else {
                    let puzzleHtml = '';
                    if (s.id === 'gym') puzzleHtml = this.getGymPuzzle();
                    else if (s.id === 'subway') puzzleHtml = this.getSubwayPuzzle();
                    else if (s.id === 'lake') puzzleHtml = this.getLakePuzzle();
                    else if (s.id === 'library') puzzleHtml = this.getLibraryPuzzle();
                    else if (s.id === 'waffle') puzzleHtml = this.getWafflePuzzle();
                    else if (s.id === 'gate') puzzleHtml = this.getGatePuzzle();
                    else if (s.id === 'bell') puzzleHtml = this.getBellPuzzle();
                    else if (s.id === 'palm') puzzleHtml = this.getPalmPuzzle();

                    content += `
                        <div class="card fade-in">
                            <div class="img-container">
                                <img src="${s.image || s.hintImage}" class="img-cover">
                            </div>
                            <div style="color:#94a3b8; font-size:0.9rem; margin-bottom:20px;">${s.desc}</div>
                            ${puzzleHtml}
                        </div>`;
                }
                container.innerHTML = content;

                if(isArrived) {
                    if(s.id === 'library') this.initLibraryEvents(); 
                    if(s.id === 'waffle') this.initWaffleEvents();
                    if(s.id === 'gate') this.initGateLock();
                    if(s.id === 'palm') this.initPalmEvents();
                }
            },

            // GPS
            verifyLocation(id) {
                const s = STAGES[id];
                const stat = document.getElementById('check-status');
                stat.textContent = "正在定位...";

                if (!navigator.geolocation) { stat.textContent = "不支援 GPS"; return; }
                navigator.geolocation.getCurrentPosition(
                    (p) => {
                        const dist = this.getDist(p.coords.latitude, p.coords.longitude, s.lat, s.lon) * 1000;
                        if (dist < 100) {
                            stat.textContent = "成功！";
                            setTimeout(() => this.forceArrive(id), 1000);
                        } else {
                            stat.textContent = "距離過遠 (" + Math.round(dist) + "m)";
                            this.toast('位置太遠');
                        }
                    },
                    (e) => { stat.textContent = "GPS 失敗"; },
                    { enableHighAccuracy: true }
                );
            },
            
            requestAdminSkip(id) {
                const code = prompt("輸入救援碼：");
                if (code === ADMIN_PASS) {
                    this.forceArrive(id);
                } else if(code !== null) {
                    alert("密碼錯誤");
                }
            },

            forceArrive(id) {
                if (!this.state.arrivedStages.includes(id)) {
                    this.state.arrivedStages.push(id);
                    this.saveProgress();
                }
                this.render();
            },

            // Puzzles
            highlightError(id) {
                const el = document.getElementById(id);
                if(el) {
                    el.style.borderBottomColor = '#ef4444';
                    setTimeout(() => el.style.borderBottomColor = '#334155', 1000);
                }
            },

            checkAnswer(id, inp, ans) {
                const v = document.getElementById(inp).value.trim().toUpperCase();
                if (v === ans.toString()) this.completeStage(id);
                else { this.toast('答案錯誤'); this.highlightError(inp); }
            },

            checkAnswerText(id, inp, anss) {
                const v = document.getElementById(inp).value.trim();
                if (anss.includes(v)) this.completeStage(id);
                else { this.toast('答案錯誤'); this.highlightError(inp); }
            },

            completeStage(id) {
                if (!this.state.completedStages.includes(id)) {
                    this.state.completedStages.push(id);
                    this.saveProgress();
                    alert("解鎖成功！");
                }
                this.render();
            },

            // Puzzle HTML Generators
            getGymPuzzle() {
                return `<div>
                    <p style="color:#94a3b8; font-size:0.9rem;">$f(x) = x^3 - 3x + 1$，求 x>0 的局部極小值？</p>
                    <input type="text" id="ans-gym" placeholder="輸入數值" class="input-field">
                    <button onclick="app.checkAnswer('gym', 'ans-gym', '-1')" class="btn-neon" style="margin-top:10px;">驗證</button>
                </div>`;
            },
            
            getLakePuzzle() {
                return `<div>
                    <p style="color:#94a3b8; font-size:0.9rem;">李白《月下獨酌》中，描述物理現象結果的詩句（五個字）？</p>
                    <input type="text" id="ans-lake" placeholder="輸入詩句" class="input-field">
                    <button onclick="app.checkAnswerText('lake', 'ans-lake', ['對影成三人'])" class="btn-neon" style="margin-top:10px;">驗證</button>
                </div>`;
            },

            getSubwayPuzzle() {
                const opts = ['台北車站', '新店', '秀朗橋', '南勢角', '雙連', '忠孝復興', '龍山寺', '中和', '行天宮', '小碧潭'];
                let h = `<div style="margin-bottom:15px; color:#94a3b8; font-size:0.9rem;">條件：離公館6站內、換線最多1次。請勾選：</div><div class="grid-2">`;
                opts.forEach(o => h += `<label class="checkbox-label"><input type="checkbox" name="subway-opt" value="${o}"> <span style="color:#e2e8f0; font-size:0.8rem;">${o}</span></label>`);
                return h + `</div><button onclick="app.checkSubwayAns()" class="btn-neon" style="margin-top:10px;">驗證</button>`;
            },
            checkSubwayAns() {
                const corr = ['台北車站', '新店', '秀朗橋', '南勢角', '龍山寺', '行天宮', '小碧潭'].sort();
                const chk = Array.from(document.querySelectorAll('input[name="subway-opt"]:checked')).map(e => e.value).sort();
                if(corr.length === chk.length && corr.every((v, i) => v === chk[i])) this.completeStage('subway'); else this.toast('選擇錯誤');
            },

            getBellPuzzle() {
                return `
                    <div style="display:flex; flex-direction:column; gap:10px;">
                        <div><label style="font-size:0.7rem; color:#94a3b8;">Q1 音速 (m/s)</label><input type="number" id="bell-q1" class="input-field"></div>
                        <div><label style="font-size:0.7rem; color:#94a3b8;">Q2 假喇叭提早 (s)</label><input type="number" id="bell-q2" class="input-field"></div>
                        <div><label style="font-size:0.7rem; color:#94a3b8;">Q3 倒數 (s)</label><input type="number" id="bell-q3" class="input-field"></div>
                    </div>
                    <button onclick="app.checkBellAns()" class="btn-neon" style="margin-top:15px;">驗證</button>
                `;
            },
            checkBellAns() {
                const q1 = document.getElementById('bell-q1').value, q2 = document.getElementById('bell-q2').value, q3 = document.getElementById('bell-q3').value;
                if(q1=='340' && q2=='11.4' && q3=='72') this.completeStage('bell'); else this.toast('答案錯誤');
            },

            getLibraryPuzzle() {
                return `
                    <div style="display:flex; flex-direction:column; gap:10px;">
                        <div><label style="font-size:0.7rem; color:#94a3b8;">Q1 兩館距離 (m)</label><input type="number" id="lib-q1" class="input-field"></div>
                        <div><label style="font-size:0.7rem; color:#94a3b8;">Q2 奎哥高度 (m)</label><input type="number" id="lib-q2" class="input-field"></div>
                    </div>
                    <button onclick="app.checkLibraryAns()" class="btn-neon" style="margin-top:15px;">驗證</button>
                `;
            },
            checkLibraryAns() {
                const q1 = document.getElementById('lib-q1').value, q2 = document.getElementById('lib-q2').value;
                if(q1=='90' && q2=='21') this.completeStage('library'); else this.toast('答案錯誤');
            },

            getPalmPuzzle() {
                return `
                    <div id="color-preview" style="width:100%; height:50px; background:black; margin-bottom:10px; border-radius:4px; border:1px solid #334155;"></div>
                    <div style="margin-bottom:10px;">
                        <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#ef4444;"><span>R</span><span id="val-r">0</span></div>
                        <input type="range" id="range-r" min="0" max="255" value="0" style="width:100%;">
                    </div>
                    <div style="margin-bottom:10px;">
                        <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#10b981;"><span>G</span><span id="val-g">0</span></div>
                        <input type="range" id="range-g" min="0" max="255" value="0" style="width:100%;">
                    </div>
                    <div style="margin-bottom:10px;">
                        <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#3b82f6;"><span>B</span><span id="val-b">0</span></div>
                        <input type="range" id="range-b" min="0" max="255" value="0" style="width:100%;">
                    </div>
                    <button onclick="app.checkPalm()" class="btn-neon">確認光譜</button>
                `;
            },
            initPalmEvents() {
                const update = () => {
                    const r = document.getElementById('range-r').value;
                    const g = document.getElementById('range-g').value;
                    const b = document.getElementById('range-b').value;
                    document.getElementById('color-preview').style.backgroundColor = 'rgb('+r+','+g+','+b+')';
                    document.getElementById('val-r').innerText = r;
                    document.getElementById('val-g').innerText = g;
                    document.getElementById('val-b').innerText = b;
                };
                ['r','g','b'].forEach(c => document.getElementById('range-'+c).addEventListener('input', update));
            },
            checkPalm() {
                const r = document.getElementById('range-r').value, g = document.getElementById('range-g').value, b = document.getElementById('range-b').value;
                if(r==192 && g==28 && b==64) this.completeStage('palm'); else this.toast('光譜錯誤');
            },

            // Waffle
            getWafflePuzzle() {
                return `
                    <div style="display:flex; flex-direction:column; gap:8px; margin-bottom:15px;">
                        ${['E,G,G','B,E,E,F','C,A,B,B,A,G,E'].map((n, i) => 
                        `<div style="display:flex; gap:8px; align-items:center;">
                            <span class="mono" style="color:#d946ef;">Q${i+1}</span>
                            <button onclick="app.playMelody(['${n.split(',').join("','")}'])" style="background:#7c3aed; color:white; border:none; border-radius:50%; width:24px; height:24px;">▶</button>
                            <input type="text" id="waffle-q${i+1}" class="input-field" style="flex:1;">
                         </div>`).join('')}
                    </div>
                    <div style="text-align:center; margin-bottom:15px;"><button onclick="app.playMelody(['C'])" style="background:none; border:none; color:#94a3b8;">試聽 C (Do)</button></div>
                    <button onclick="app.checkWaffle()" class="btn-neon">驗證</button>
                `;
            },
            
            // Gate
            getGatePuzzle() {
                const letters = ['A','B','C','D','E','F','G'];
                let html = '';
                letters.forEach((l, i) => {
                    const deg = i * (360/7);
                    const rad = deg * (Math.PI/180);
                    const x = 128 + 110 * Math.sin(rad);
                    const y = 128 - 110 * Math.cos(rad);
                    html += `<div class="dial-letter" style="left:${x}px; top:${y}px; transform: translate(-50%, -50%) rotate(${deg}deg);">${l}</div>`;
                });
                return `
                    <div style="background:#0b1121; padding:10px; border-radius:8px; border:1px solid #334155; margin-bottom:20px; font-size:0.75rem; color:#94a3b8;">
                        <div>A.改為國立臺灣大學 B.校友獲諾貝爾獎 C.學生數59人 D.首屆杜鵑花節 E.公布醫學部 F.臺大系統聯盟 G.公布校歌</div>
                    </div>
                    <div class="dial-wrapper" id="dial-container">
                        ${html}
                        <div class="dial-knob" id="gate-knob"><div class="dial-pointer"></div></div>
                    </div>
                    <div class="grid-2" style="margin-top:20px;">
                        <button onclick="app.resetGateLock()" class="btn-secondary">重設</button>
                        <button onclick="app.confirmGateSelection()" class="btn-neon">鎖定</button>
                    </div>
                    <div id="gate-progress" style="margin-top:10px; display:flex; justify-content:center; gap:5px;"></div>
                `;
            },
            initGateLock() {
                this.gateRotation = 0; this.gateLockIndex = 0; this.gateLockSequence = []; this.updateGateUI();
                const knob = document.getElementById('gate-knob');
                // Simple touch logic for knob
                knob.onclick = () => {
                    this.gateRotation += (360/7);
                    knob.style.transform = 'translate(-50%, -50%) rotate('+this.gateRotation+'deg)';
                };
            },
            resetGateLock() {
                this.gateLockIndex = 0; this.gateLockSequence = []; this.gateRotation = 0;
                document.getElementById('gate-knob').style.transform = 'translate(-50%, -50%) rotate(0deg)';
                this.updateGateUI();
            },
            confirmGateSelection() {
                const letters = ['A','B','C','D','E','F','G'];
                let idx = Math.round((this.gateRotation % 360) / (360/7)) % 7;
                this.gateLockSequence.push(letters[idx]);
                this.gateLockIndex++;
                if(this.gateLockIndex < 7) { this.updateGateUI(); }
                else {
                    if(this.gateLockSequence.join('') === 'CEAGBDF') this.completeStage('gate');
                    else { this.toast('錯誤'); this.resetGateLock(); }
                }
            },
            updateGateUI() {
                let html = '';
                for(let i=0; i<7; i++) {
                    const filled = i < this.gateLockIndex;
                    html += `<div style="width:20px; height:20px; border:1px solid #334155; text-align:center; color:white; background:${filled?'#d946ef':'transparent'}">${filled?this.gateLockSequence[i]:''}</div>`;
                }
                document.getElementById('gate-progress').innerHTML = html;
            },

            // Clues & Final
            renderClues(container) {
                let html = '<div class="grid-2">';
                TEAM_ROUTES[this.state.teamId].forEach(k => {
                    const u = this.state.completedStages.includes(k);
                    const s = STAGES[k];
                    html += `<div class="card" style="text-align:center;">${u ? `<span style="font-size:2rem; color:#38bdf8; font-weight:bold;">${s.code}</span>` : '<i class="fa-solid fa-lock" style="font-size:1.5rem; color:#334155;"></i>'}</div>`;
                });
                container.innerHTML = html + '</div>';
            },
            renderFinal(container) {
                 const ok = this.state.completedStages.length === TEAM_ROUTES[this.state.teamId].length;
                 container.innerHTML = `<div class="card text-center"><p class="text-sub mb-4">輸入密碼：</p><input id="final-code" class="input-field" ${!ok?'disabled':''}><button onclick="app.checkFinal()" class="btn-neon" style="margin-top:15px;">解密</button></div>`;
            },
            checkFinal() {
                if(btoa(document.getElementById('final-code').value.trim().toUpperCase()) === FINAL_ANSWER_HASH) {
                    alert("ACCESS GRANTED! Hash: " + Date.now().toString(16).toUpperCase());
                } else { this.toast('錯誤'); }
            },

            // Utility
            playMelody(notes) {
                this.initAudio();
                notes.forEach((n, i) => {
                    if(!this.noteFreqs[n]) return;
                    const osc = this.audioCtx.createOscillator();
                    const gain = this.audioCtx.createGain();
                    osc.connect(gain); gain.connect(this.audioCtx.destination);
                    osc.frequency.value = this.noteFreqs[n];
                    gain.gain.setValueAtTime(0.1, this.audioCtx.currentTime + i*0.5);
                    gain.gain.exponentialRampToValueAtTime(0.001, this.audioCtx.currentTime + i*0.5 + 0.4);
                    osc.start(this.audioCtx.currentTime + i*0.5);
                    osc.stop(this.audioCtx.currentTime + i*0.5 + 0.4);
                });
            },
            getDist(lat1, lon1, lat2, lon2) {
                var R = 6371; 
                var dLat = (lat2-lat1) * (Math.PI/180);
                var dLon = (lon2-lon1) * (Math.PI/180); 
                var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*(Math.PI/180)) * Math.cos(lat2*(Math.PI/180)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
                return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
            },
            toast(msg) {
                const t = document.getElementById('toast');
                document.getElementById('toast-msg').innerText = msg;
                t.style.opacity = 1;
                setTimeout(()=>t.style.opacity=0, 2000);
            }
        };

        window.onload = function() { app.init(); };
    </script>
</body>
</html>
