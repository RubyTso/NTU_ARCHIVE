<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Project: NTU_ARCHIVE | 台大校園實境解謎</title>
    <!-- 設定網頁 Favicon (瀏覽器分頁圖示) -->
    <link rel="icon" type="image/png" href="images/logo.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ntu: {
                            bg: '#0b1121', // Deep midnight blue
                            card: '#151e32', // Slightly lighter blue for cards
                            accent: '#38bdf8', // Sky blue text
                            border: '#1e293b', // Slate border
                            yellow: '#fbbf24', // Amber for highlights
                        }
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    boxShadow: {
                        'neon': '0 0 10px rgba(56, 189, 248, 0.5)',
                        'dial-inset': 'inset 0 0 20px rgba(0,0,0,0.8)',
                        'dial-out': '0 0 15px rgba(0,0,0,0.5)',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #0b1121;
            color: #e2e8f0;
            overflow-x: hidden;
            touch-action: manipulation;
        }
        
        /* 掃描線動畫 */
        .scanline {
            width: 100%; height: 100px; z-index: 10;
            background: linear-gradient(0deg, rgba(0,0,0,0) 0%, rgba(56, 189, 248, 0.03) 50%, rgba(0,0,0,0) 100%);
            opacity: 0.4; position: absolute; bottom: 100%;
            animation: scanline 8s linear infinite; pointer-events: none;
        }
        @keyframes scanline { 0% { bottom: 100%; } 100% { bottom: -100%; } }

        /* 霓虹背景光暈 */
        .neon-glow {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1;
            background: 
                radial-gradient(circle at 10% 20%, rgba(56, 189, 248, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(192, 38, 211, 0.05) 0%, transparent 40%);
        }

        /* 全新霓虹按鈕樣式 */
        .btn-neon {
            background: linear-gradient(90deg, #d946ef 0%, #7c3aed 100%); 
            color: white;
            font-weight: bold;
            border-radius: 0.5rem;
            border: none;
            box-shadow: 0 0 15px rgba(217, 70, 239, 0.4); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .btn-neon:hover {
            box-shadow: 0 0 25px rgba(217, 70, 239, 0.6);
            transform: translateY(-2px);
            filter: brightness(1.1);
        }
        .btn-neon:active {
            transform: translateY(1px);
            box-shadow: 0 0 10px rgba(217, 70, 239, 0.3);
        }
        .btn-neon::after {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.15) 0%, transparent 50%);
            pointer-events: none;
        }

        /* 轉盤樣式 */
        .dial-container {
            position: relative; width: 280px; height: 280px; margin: 0 auto;
            border-radius: 50%; 
            background: linear-gradient(145deg, #1a233a, #0f1623);
            border: 12px solid #1e293b;
            box-shadow: 
                5px 5px 15px #070b15, 
                -5px -5px 15px #1f2b45,
                inset 0 0 20px #000;
            user-select: none;
        }
        .dial-track {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 180px; height: 180px; border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.1);
            pointer-events: none;
        }
        .dial-letter {
            position: absolute; width: 40px; height: 40px;
            text-align: center; line-height: 40px; 
            color: #94a3b8; font-weight: bold; font-family: 'JetBrains Mono', monospace; font-size: 1.2rem;
            pointer-events: none; transform-origin: center center;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .dial-knob {
            position: absolute; top: 50%; left: 50%;
            width: 170px; height: 170px; margin-left: -85px; margin-top: -85px;
            background: #151e32;
            border-radius: 50%;
            box-shadow: 
                0 4px 10px rgba(0,0,0,0.5),
                inset 0 1px 1px rgba(255,255,255,0.1);
            z-index: 10; cursor: grab;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid #334155;
        }
        .dial-knob:active { cursor: grabbing; border-color: #d946ef; }
        
        .dial-pointer {
            position: absolute; top: -14px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-bottom: 20px solid #fbbf24;
            filter: drop-shadow(0 0 5px rgba(251, 191, 36, 0.6));
        }

        .term-input {
            background: transparent; border: none; border-bottom: 2px solid #334155;
            color: #d946ef; outline: none; transition: all 0.3s;
            font-family: 'JetBrains Mono', monospace;
        }
        .term-input:focus { border-bottom-color: #d946ef; background: rgba(217, 70, 239, 0.05); }

        .ntu-card {
            background: #151e32;
            border: 1px solid #1e293b;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 2px; }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-center relative">

    <div class="scanline fixed inset-0 h-full w-full pointer-events-none"></div>
    <div class="neon-glow"></div>

    <!-- Header -->
    <header class="fixed top-0 w-full bg-ntu-bg/90 backdrop-blur-md border-b border-ntu-border z-50 p-4 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <span class="text-fuchsia-500 font-bold text-lg select-none">&gt;_</span>
            <span class="mono font-bold text-gray-100 tracking-wider">NTU_SYSTEM</span>
        </div>
        <div class="flex gap-4 text-xs mono items-center">
            <div id="team-display" class="text-fuchsia-400 font-bold px-2 py-1 bg-fuchsia-500/10 rounded"></div>
            <button onclick="app.resetGame()" class="text-red-400 hover:text-red-300 transition flex items-center gap-1">
                <i class="fa-solid fa-triangle-exclamation"></i> 重置
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main id="app-container" class="w-full max-w-md h-full pt-20 pb-24 px-4 overflow-y-auto relative scroll-smooth">
        <!-- JS Render Content -->
    </main>

    <!-- Bottom Nav -->
    <nav class="fixed bottom-0 w-full max-w-md bg-ntu-bg border-t border-ntu-border p-3 grid grid-cols-3 gap-6 z-40">
        <button onclick="app.navigate('mission')" class="flex flex-col items-center gap-1 text-slate-500 hover:text-white transition active-nav">
            <i class="fa-solid fa-location-arrow text-lg"></i> <span class="text-[10px] mono">當前任務</span>
        </button>
        <button onclick="app.navigate('clues')" class="flex flex-col items-center gap-1 text-slate-500 hover:text-white transition">
            <i class="fa-solid fa-key text-lg"></i> <span class="text-[10px] mono">金鑰碎片</span>
        </button>
        <button onclick="app.navigate('final')" class="flex flex-col items-center gap-1 text-slate-500 hover:text-white transition">
            <i class="fa-solid fa-lock text-lg"></i> <span class="text-[10px] mono">終端解碼</span>
        </button>
    </nav>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-slate-800 border border-fuchsia-500/30 text-white px-6 py-3 rounded shadow-2xl opacity-0 transition-opacity duration-300 pointer-events-none z-50 flex items-center gap-3 min-w-max">
        <i class="fa-solid fa-circle-info text-fuchsia-400"></i> <span id="toast-msg" class="font-mono text-sm">Message</span>
    </div>

    <script>
        // 定義每一關獨立的救援密碼
        const STAGES = {
            'gate': {
                id: 'gate', name: '台大校門', code: '2',
                lat: 25.017014, lon: 121.533854,
                rescueCode: 'NTU1928', // 專屬救援碼
                hintTitle: '知識的入口',
                hintDesc: '大學生涯的起點，昔日的帝國大學門戶。',
                hintImage: 'images/gate.jpg', 
                icon: 'fa-torii-gate', title: '時光刻度',
                desc: '請轉動圓盤，依發生年代將校史事件排序。',
                difficultyLabel: '歷史排序', type: 'lock'
            },
            'palm': {
                id: 'palm', name: '椰林大道', code: '2', 
                lat: 25.017278, lon: 121.534977, 
                rescueCode: 'PALM96', 
                hintTitle: '熱帶的守望者',
                hintDesc: '筆直的大道，兩旁高聳的植物見證了無數學子的來去。',
                hintImage: 'images/palm.jpg', 
                icon: 'fa-tree', title: '光譜密碼',
                desc: '尋找隱藏在椰林光影中的「台大紅」。請根據數學線索調配出正確的 RGB 數值。',
                difficultyLabel: '色彩數學', type: 'color'
            },
            'bell': {
                id: 'bell', name: '傅鐘', code: '2',
                lat: 25.017246, lon: 121.536768,
                rescueCode: 'RING21',
                hintTitle: '時間的警鐘',
                hintDesc: '為了紀念一位偉大的校長，這裡的鐘聲總是依循他的名言敲響。',
                hintImage: 'images/bell.jpg', 
                icon: 'fa-bell', title: '聲速奧秘',
                desc: '期末考這天，奎哥第一節課快遲到，學校規定：只有當傅鐘「最後一下敲完」那一刻才算遲到。他在路口時聽到鐘聲，卻發現有人惡作劇放了「假傅鐘」喇叭，播放幾乎一樣的鐘聲來混淆同學。請你協助他分辨真假傅鐘的聲響，計算音速與時間差。',
                difficultyLabel: '物理數學', type: 'physics'
            },
            'gym': {
                id: 'gym', name: '舊體育館', code: 'D',
                lat: 25.020000, lon: 121.536569,
                rescueCode: 'OLDGYM7',
                hintTitle: '古典競技場',
                hintDesc: '校園中最古老的體育建築，門口的羅馬柱是其特徵。',
                hintImage: 'images/gym.jpg', 
                icon: 'fa-dumbbell', title: '函數極值',
                desc: '彈道軌跡隱藏在古老的建築結構中。尋找三次函數的局部最低點。',
                difficultyLabel: '數學微積分', type: 'math'
            },
            'lake': {
                id: 'lake', name: '醉月湖', code: 'L',
                rescueCode: 'MOON33',
                lat: 25.020571, lon: 121.537626,
                hintTitle: '詩人的倒影',
                hintDesc: '校園中的一抹碧波，湖心亭是其標誌。',
                hintImage: 'images/lake.jpg', 
                icon: 'fa-water', title: '光學推演', 
                desc: '分析場景中的物理條件（光源、反射介質），推導出李白觀測到的光學成像結果。',
                difficultyLabel: '物理文學', type: 'literature'
            },
            'library': {
                id: 'library', name: '總圖書館', code: 'C',
                rescueCode: 'READ88',
                lat: 25.017392, lon: 121.540527,
                hintTitle: '知識的堡壘',
                hintDesc: '校園的幾何中心，保存著百萬藏書的宏偉建築。',
                hintImage: 'images/library.jpg', 
                icon: 'fa-book', title: '三角測量',
                desc: '奎哥從台大總圖書館樓頂觀測校園，請利用俯角觀測數據，計算建築物的距離與高度。',
                difficultyLabel: '數學幾何', type: 'math'
            },
            'waffle': {
                id: 'waffle', name: '小木屋', code: '0', 
                rescueCode: 'YUMMY00',
                lat: 25.015684, lon: 121.537550,
                hintTitle: '甜蜜的角落',
                hintDesc: '排隊人潮總是絡績不絕，空氣中飄散著鬆餅的香氣。',
                hintImage: 'images/waffle.jpg', 
                icon: 'fa-utensils', title: '音律食材',
                desc: '美味秘密藏在旋律裡。聆聽音符辨識「音名」，拼出英文食材單字。',
                difficultyLabel: '音樂聽寫', type: 'music'
            },
            'subway': {
                id: 'subway', name: '公館捷運', code: 'E',
                rescueCode: 'EXIT3',
                lat: 25.014711, lon: 121.534687,
                hintTitle: '地下的脈動',
                hintDesc: '校園旁的交通樞紐，四通八達的捷運路網。',
                hintImage: 'images/subway.jpg', 
                icon: 'fa-train-subway', title: '捷運租屋',
                desc: '奎哥就讀「台灣大學」他想在學校附近租屋。請協助他篩選符合通勤條件的捷運站。',
                difficultyLabel: '生活地理', type: 'checkbox'
            }
        };

        const TEAM_ROUTES = {
            1: ['gate', 'palm', 'bell', 'gym', 'lake', 'library', 'waffle', 'subway'],
            2: ['bell', 'gym', 'lake', 'library', 'waffle', 'subway', 'gate', 'palm'],
            3: ['gym', 'lake', 'library', 'waffle', 'subway', 'gate', 'palm', 'bell'],
            4: ['subway', 'gate', 'palm', 'bell', 'gym', 'lake', 'library', 'waffle'],
            5: ['waffle', 'subway', 'gate', 'palm', 'bell', 'gym', 'lake', 'library'],
            6: ['library', 'waffle', 'subway', 'gate', 'palm', 'bell', 'gym', 'lake'],
            7: ['lake', 'library', 'waffle', 'subway', 'gate', 'palm', 'bell', 'gym'],
            8: ['palm', 'bell', 'gym', 'lake', 'library', 'waffle', 'subway', 'gate']
        };

        const FINAL_ANSWER_HASH = "REVMQ18yMDIy"; 

        const app = {
            state: {
                teamId: null,
                completedStages: [], arrivedStages: [],   
                stageScores: {}, stageStartTimes: {}, 
                currentView: 'intro', 
                gateLockIndex: 0, gateLockSequence: [] 
            },
            
            audioCtx: null,
            noteFreqs: { 'C': 261.63, 'D': 293.66, 'E': 329.63, 'F': 349.23, 'G': 392.00, 'A': 440.00, 'B': 493.88 },

            init() { this.loadProgress(); this.render(); },

            initAudio() {
                if(!this.audioCtx) this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if(this.audioCtx.state === 'suspended') this.audioCtx.resume();
            },

            playMelody(notes) {
                this.initAudio();
                const now = this.audioCtx.currentTime;
                notes.forEach((n, i) => {
                    if(!this.noteFreqs[n]) return;
                    const osc = this.audioCtx.createOscillator();
                    const gain = this.audioCtx.createGain();
                    const t = now + i * 0.6;
                    osc.type = 'triangle';
                    osc.frequency.value = this.noteFreqs[n];
                    osc.connect(gain);
                    gain.connect(this.audioCtx.destination);
                    gain.gain.setValueAtTime(0, t);
                    gain.gain.linearRampToValueAtTime(0.3, t + 0.05);
                    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.5);
                    osc.start(t);
                    osc.stop(t + 0.5);
                });
            },

            loadProgress() {
                const team = localStorage.getItem('ntu_puzzle_team');
                const c = localStorage.getItem('ntu_puzzle_completed');
                const a = localStorage.getItem('ntu_puzzle_arrived');
                const s = localStorage.getItem('ntu_puzzle_scores');
                const t = localStorage.getItem('ntu_puzzle_start_times');
                
                if (team) {
                    this.state.teamId = parseInt(team);
                    if (c) this.state.completedStages = JSON.parse(c);
                    if (a) this.state.arrivedStages = JSON.parse(a);
                    if (s) this.state.stageScores = JSON.parse(s);
                    if (t) this.state.stageStartTimes = JSON.parse(t);
                    this.state.currentView = 'mission';
                }
            },

            saveProgress() {
                if(this.state.teamId) localStorage.setItem('ntu_puzzle_team', this.state.teamId);
                localStorage.setItem('ntu_puzzle_completed', JSON.stringify(this.state.completedStages));
                localStorage.setItem('ntu_puzzle_arrived', JSON.stringify(this.state.arrivedStages));
                localStorage.setItem('ntu_puzzle_scores', JSON.stringify(this.state.stageScores));
                localStorage.setItem('ntu_puzzle_start_times', JSON.stringify(this.state.stageStartTimes));
                this.updateUI(); 
            },
            
            updateUI() {
                if(this.state.teamId) {
                    const teamDisp = document.getElementById('team-display');
                    if (teamDisp) teamDisp.textContent = `小隊 ${this.state.teamId}`;
                }
                document.querySelectorAll('nav button').forEach(btn => {
                   const onclickAttr = btn.getAttribute('onclick');
                   if(!onclickAttr) return;
                   const match = onclickAttr.match(/'([^']+)'/);
                   if (!match) return;
                   const view = match[1];
                   if(view === this.state.currentView) {
                       btn.classList.add('text-fuchsia-400');
                       btn.classList.remove('text-slate-500');
                   } else {
                       btn.classList.remove('text-fuchsia-400');
                       btn.classList.add('text-slate-500');
                   }
                });
            },

            resetGame() {
                if(confirm('確定要重置所有進度嗎？(包含小隊設定)')) {
                    localStorage.clear();
                    location.reload();
                }
            },

            setTeam(id) {
                this.state.teamId = id;
                this.saveProgress();
                this.navigate('mission');
            },

            navigate(view) {
                this.state.currentView = view;
                this.state.gateLockIndex = 0; 
                this.state.gateLockSequence = [];
                this.render();
            },

            toast(msg) {
                const t = document.getElementById('toast');
                const m = document.getElementById('toast-msg');
                if (t && m) {
                    m.textContent = msg;
                    t.classList.remove('opacity-0');
                    setTimeout(() => t.classList.add('opacity-0'), 3000);
                }
            },

            requestAdminSkip(id) {
                const s = STAGES[id];
                const input = prompt(`請輸入[${s.name}]專屬救援碼：`);
                if (input === s.rescueCode) {
                    this.forceArrive(id);
                    this.toast(`${s.name} 位置已強制解鎖`);
                } else if (input !== null) {
                    alert("救援碼無效！");
                }
            },

            render() {
                const container = document.getElementById('app-container');
                if (!container) return;
                container.innerHTML = '';
                this.updateUI();
                
                if (!this.state.teamId) {
                    this.renderIntro(container);
                    return;
                }

                if(this.state.currentView === 'intro') this.navigate('mission'); 
                else if(this.state.currentView === 'mission') this.renderMission(container);
                else if(this.state.currentView === 'clues') this.renderClues(container);
                else if(this.state.currentView === 'final') this.renderFinal(container);
            },

            renderIntro(container) {
                let buttonsHtml = '';
                for(let i=1; i<=8; i++) {
                    buttonsHtml += `<button onclick="app.setTeam(${i})" class="p-4 bg-ntu-card border border-ntu-border rounded-lg hover:border-fuchsia-500 hover:shadow-[0_0_10px_rgba(217,70,239,0.5)] hover:text-fuchsia-400 transition duration-300 font-mono text-sm">小隊 0${i}</button>`;
                }

                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center min-h-full py-10 space-y-6 fade-in relative z-10">
                        <div class="absolute w-64 h-64 bg-fuchsia-500/20 rounded-full blur-[80px] -z-10"></div>
                        
                        <div class="w-28 h-28 rounded-full overflow-hidden border-4 border-fuchsia-500/50 shadow-[0_0_20px_rgba(217,70,239,0.3)] relative group">
                            <div class="absolute inset-0 bg-fuchsia-500/10 group-hover:bg-transparent transition"></div>
                            <img src="images/logo.png" alt="Team Logo" class="w-full h-full object-cover p-1 bg-white/10 backdrop-blur-sm">
                        </div>
                        
                        <div class="text-3xl font-mono text-fuchsia-400 font-bold tracking-[0.3em] drop-shadow-neon mt-2 text-center">
                            NTU ARCHIVE
                        </div>

                        <div class="w-full max-w-xs space-y-4">
                            <p class="text-slate-400 text-sm mb-6 text-center">請選擇小隊編號以存取資料庫</p>
                            <div class="grid grid-cols-2 gap-4">
                                ${buttonsHtml}
                            </div>
                        </div>
                    </div>`;
            },

            renderMission(container) {
                const route = TEAM_ROUTES[this.state.teamId];
                const currentIndex = this.state.completedStages.length;
                
                if (currentIndex >= route.length) {
                    container.innerHTML = `
                        <div class="h-full flex flex-col items-center justify-center text-center fade-in">
                            <div class="w-20 h-20 rounded-full bg-ntu-card flex items-center justify-center border border-fuchsia-500 mb-6 shadow-[0_0_15px_rgba(217,70,239,0.5)]">
                                <i class="fa-solid fa-flag-checkered text-4xl text-ntu-yellow"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-white mb-2">任務全數完成</h2>
                            <p class="text-slate-400 mb-8 text-sm">所有資料碎片已收集完畢。<br>請前往終端解碼以完成任務。</p>
                            <button onclick="app.navigate('final')" class="px-8 py-4 btn-neon w-64 shadow-lg">
                                <i class="fa-solid fa-terminal mr-2"></i> 前往終端機
                            </button>
                        </div>
                    `;
                    return;
                }

                const currentStageId = route[currentIndex];
                const s = STAGES[currentStageId];
                const isArrived = this.state.arrivedStages.includes(currentStageId);

                let content = '';
                
                content += `
                    <div class="mb-6 flex items-center justify-between">
                        <div>
                            <div class="text-xs font-mono text-fuchsia-400 mb-1">CURRENT_MISSION</div>
                            <h2 class="text-xl font-bold text-white tracking-wide">任務 ${currentIndex + 1} <span class="text-slate-500 text-sm">/ ${route.length}</span></h2>
                        </div>
                        <div class="text-xs px-2 py-1 rounded border border-ntu-border bg-ntu-card text-slate-400">
                            ${isArrived ? `<i class="fa-solid fa-location-dot text-fuchsia-400 mr-1"></i> ${s.name}` : '<i class="fa-solid fa-lock text-slate-600 mr-1"></i> 地點加密'}
                        </div>
                    </div>
                `;

                if (!isArrived) {
                    content += `
                        <div class="fade-in ntu-card p-5">
                            <div class="mb-4">
                                <div class="flex items-center gap-2 mb-3">
                                    <i class="fa-solid fa-map-pin text-red-400"></i>
                                    <h3 class="text-lg font-bold text-white">${s.hintTitle}</h3>
                                </div>
                                <div class="rounded-lg overflow-hidden border border-ntu-border mb-4 shadow-lg relative group">
                                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent z-10"></div>
                                    <img src="${s.hintImage}" class="w-full h-56 object-cover group-hover:scale-105 transition duration-700" onerror="this.src='https://via.placeholder.com/400x220/151e32/38bdf8?text=NO+IMAGE'">
                                    <div class="absolute bottom-3 left-3 z-20 text-xs text-white/80 mono">REF_IMG_${currentStageId.toUpperCase()}</div>
                                </div>
                                <p class="text-slate-300 text-sm leading-relaxed mb-6 border-l-2 border-ntu-border pl-3">${s.hintDesc}</p>
                            </div>
                            
                            <div class="border-t border-ntu-border pt-6 text-center">
                                <button onclick="app.verifyLocation('${s.id}')" class="w-full btn-neon py-4 text-lg flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-satellite-dish"></i> 掃描目前位置
                                </button>
                                <div id="check-status" class="text-xs text-ntu-yellow mt-3 min-h-[3rem] font-mono whitespace-pre-line leading-relaxed"></div>
                                <div class="mt-4">
                                    <button onclick="app.requestAdminSkip('${s.id}')" class="text-[10px] text-slate-600 hover:text-slate-400 font-mono tracking-wider">
                                        <i class="fa-solid fa-triangle-exclamation mr-1"></i> 定位異常？(輸入該關救援碼)
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    let puzzleHtml = '';
                    switch (s.id) {
                        case 'gym': puzzleHtml = this.getGymPuzzle(); break;
                        case 'subway': puzzleHtml = this.getSubwayPuzzle(); break;
                        case 'lake': puzzleHtml = this.getLakePuzzle(); break;
                        case 'library': puzzleHtml = this.getLibraryPuzzle(); break;
                        case 'waffle': puzzleHtml = this.getWafflePuzzle(); break;
                        case 'gate': puzzleHtml = this.getGatePuzzle(); break;
                        case 'bell': puzzleHtml = this.getBellPuzzle(); break;
                        case 'palm': puzzleHtml = this.getPalmPuzzle(); break;
                    }

                    content += `
                        <div class="fade-in ntu-card p-5">
                            <div class="flex items-center justify-between mb-4 border-b border-ntu-border pb-3">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded bg-ntu-bg flex items-center justify-center border border-ntu-border">
                                        <i class="fa-solid ${s.icon} text-fuchsia-400"></i>
                                    </div>
                                    <span class="text-lg font-bold text-white">${s.name}</span>
                                </div>
                                <span class="text-[10px] bg-ntu-bg border border-ntu-border px-2 py-1 rounded text-slate-400 font-mono">${s.difficultyLabel}</span>
                            </div>
                            <div class="text-sm text-slate-300 mb-6 leading-relaxed">${s.desc}</div>
                            ${puzzleHtml}
                        </div>
                    `;
                }

                container.innerHTML = content;

                if(isArrived) {
                    if(s.id === 'library') this.initLibraryEvents(); 
                    if(s.id === 'waffle') this.initWaffleEvents();
                    if(s.id === 'gate') this.initGateLock();
                    if(s.id === 'palm') this.initPalmEvents();
                }
            },

            verifyLocation(id) {
                const s = STAGES[id];
                const stat = document.getElementById('check-status');
                if (!stat) return;

                // 視覺更新：倒數與提示
                let timeLeft = 30; 
                stat.textContent = `衛星連線中 (預計 ${timeLeft}s)...\n請確保位於室外空曠處並開啟 WiFi。`;
                stat.className = "text-xs text-fuchsia-400 animate-pulse mt-3 min-h-[3rem] font-mono whitespace-pre-line";

                const countdown = setInterval(() => {
                    timeLeft--;
                    if (timeLeft > 0) {
                        stat.textContent = `正在獲取座標 (預計 ${timeLeft}s)...\n環境遮蔽可能影響定位速度。`;
                    } else {
                        clearInterval(countdown);
                    }
                }, 1000);

                if (!navigator.geolocation) { 
                    clearInterval(countdown);
                    stat.textContent = "錯誤：瀏覽器不支援定位服務。"; 
                    stat.className = "text-xs text-red-500 mt-3 min-h-[3rem] font-mono";
                    return; 
                }

                // 第一次嘗試：高精準度 (30秒逾時)
                const highAccuracyOptions = { 
                    enableHighAccuracy: true, 
                    timeout: 30000, 
                    maximumAge: 0 
                };

                const successCallback = (p) => {
                    clearInterval(countdown);
                    const dist = this.getDist(p.coords.latitude, p.coords.longitude, s.lat, s.lon) * 1000;
                    if (dist < 100) {
                        stat.textContent = "✔ 訊號捕獲成功！\n位置匹配完成，正在解鎖系統節點...";
                        stat.className = "text-xs text-emerald-400 font-bold mt-3 min-h-[3rem] font-mono whitespace-pre-line";
                        setTimeout(() => this.forceArrive(id), 1200);
                    } else {
                        stat.textContent = `✘ 偵測中... 目前距離目標約 ${Math.round(dist)} 公尺。\n(精準度: ${Math.round(p.coords.accuracy)}m)`;
                        stat.className = "text-xs text-amber-400 mt-3 min-h-[3rem] font-mono whitespace-pre-line";
                        this.toast('距離過遠，請再靠近目標地點一些');
                    }
                };

                const errorCallback = (e) => {
                    clearInterval(countdown);
                    console.warn(`Geolocation Error (${e.code}): ${e.message}`);
                    
                    // 如果是逾時，且還沒試過低精度模式，則進行二次備案嘗試
                    if (e.code === e.TIMEOUT) {
                        stat.textContent = "高精度定位逾時，正在嘗試基礎定位模式...";
                        navigator.geolocation.getCurrentPosition(successCallback, (e2) => {
                            let msg = "定位失敗：請檢查手機 GPS 設定。";
                            if (e2.code === e.PERMISSION_DENIED) msg = "權限被拒：請在瀏覽器設定中開啟位置存取。";
                            else if (e2.code === e.TIMEOUT) msg = "讀取逾時：環境收訊過差，請移動到空曠處重試。";
                            stat.textContent = msg;
                            stat.className = "text-xs text-red-500 mt-3 min-h-[3rem] font-mono whitespace-pre-line";
                        }, { enableHighAccuracy: false, timeout: 10000 });
                    } else {
                        let errorMsg = "GPS 讀取失敗";
                        switch(e.code) {
                            case e.PERMISSION_DENIED: errorMsg = "權限被拒：請在設定中允許瀏覽器存取位置。"; break;
                            case e.POSITION_UNAVAILABLE: errorMsg = "無法定位：請確認 GPS 已開啟且非飛航模式。"; break;
                        }
                        stat.textContent = errorMsg; 
                        stat.className = "text-xs text-red-500 mt-3 min-h-[3rem] font-mono"; 
                    }
                };

                navigator.geolocation.getCurrentPosition(successCallback, errorCallback, highAccuracyOptions);
            },

            forceArrive(id) {
                if (!this.state.arrivedStages.includes(id)) {
                    this.state.arrivedStages.push(id);
                    if (!this.state.stageStartTimes[id]) this.state.stageStartTimes[id] = Date.now();
                    this.saveProgress();
                }
                this.render();
            },

            /* --- PUZZLES 邏輯節錄 --- */
            getPalmPuzzle() {
                return `
                    <div class="bg-ntu-bg border border-ntu-border p-4 rounded mb-4">
                        <div id="color-preview" class="w-full h-16 rounded mb-4 border border-slate-600 transition-colors duration-300" style="background-color:rgb(0,0,0)"></div>
                        <div class="space-y-4">
                            <div><div class="flex justify-between mb-1"><label class="text-xs font-bold text-red-400">RED</label><span id="val-r" class="text-xs mono font-bold text-red-400">0</span></div><input type="range" id="range-r" min="0" max="255" value="0" class="w-full accent-red-500 h-2 bg-slate-700 rounded-lg appearance-none"></div>
                            <div><div class="flex justify-between mb-1"><label class="text-xs font-bold text-green-400">GREEN</label><span id="val-g" class="text-xs mono font-bold text-green-400">0</span></div><input type="range" id="range-g" min="0" max="255" value="0" class="w-full accent-green-500 h-2 bg-slate-700 rounded-lg appearance-none"></div>
                            <div><div class="flex justify-between mb-1"><label class="text-xs font-bold text-blue-400">BLUE</label><span id="val-b" class="text-xs mono font-bold text-blue-400">0</span></div><input type="range" id="range-b" min="0" max="255" value="0" class="w-full accent-blue-500 h-2 bg-slate-700 rounded-lg appearance-none"></div>
                        </div>
                    </div>
                    <button onclick="app.checkPalm()" class="w-full btn-neon py-3">確認光譜</button>`;
            },
            initPalmEvents() {
                setTimeout(() => {
                    const r = document.getElementById('range-r'), g = document.getElementById('range-g'), b = document.getElementById('range-b');
                    if(!r) return;
                    const updateColor = () => { 
                        const cp = document.getElementById('color-preview');
                        if (cp) cp.style.backgroundColor = `rgb(${r.value}, ${g.value}, ${b.value})`; 
                        document.getElementById('val-r').innerText = r.value; document.getElementById('val-g').innerText = g.value; document.getElementById('val-b').innerText = b.value;
                    };
                    [r, g, b].forEach(el => el.addEventListener('input', updateColor));
                }, 100);
            },
            checkPalm() {
                const r = document.getElementById('range-r').value, g = document.getElementById('range-g').value, b = document.getElementById('range-b').value;
                if (r == 192 && g == 28 && b == 64) this.completeStage('palm');
                else this.toast('光譜頻率錯誤');
            },

            getGatePuzzle() {
                const letters = ['A','B','C','D','E','F','G'];
                let dialHtml = '';
                const radius = 110, centerOffset = 128;
                letters.forEach((l, i) => {
                    const angleDeg = i * (360/7), angleRad = angleDeg * (Math.PI/180);
                    const x = centerOffset + radius * Math.sin(angleRad), y = centerOffset - radius * Math.cos(angleRad);
                    dialHtml += `<div class="dial-letter" style="left:${x}px; top:${y}px; transform: translate(-50%, -50%) rotate(${angleDeg}deg);">${l}</div>`;
                });
                return `
                    <div class="select-none">
                        <div class="dial-container mb-6" id="dial-container">
                            <div class="dial-track"></div>${dialHtml}
                            <div class="dial-knob" id="gate-knob"><div class="dial-pointer"></div><div class="text-center"><div class="text-5xl font-bold text-white font-mono mt-1" id="gate-seq-num">1</div></div></div>
                        </div>
                        <div class="flex gap-3 mb-4">
                            <button onclick="app.resetGateLock()" class="flex-1 bg-ntu-bg border border-ntu-border text-slate-400 py-3 rounded">重設</button>
                            <button onclick="app.confirmGateSelection()" class="flex-[2] btn-neon py-3">確認鎖定</button>
                        </div>
                        <div class="flex justify-center gap-2 p-3 bg-ntu-bg rounded border border-ntu-border" id="gate-progress"></div>
                    </div>`;
            },
            initGateLock() {
                this.gateRotation = 0; this.isDragging = false; this.updateGateUI();
                const knob = document.getElementById('gate-knob'), container = document.getElementById('dial-container');
                if (!knob || !container) return;
                const start = (e) => { this.isDragging = true; e.preventDefault(); };
                const move = (e) => {
                    if (!this.isDragging) return;
                    const rect = container.getBoundingClientRect();
                    const cx = rect.left + rect.width / 2, cy = rect.top + rect.height / 2;
                    const cx_t = e.touches ? e.touches[0].clientX : e.clientX, cy_t = e.touches ? e.touches[0].clientY : e.clientY;
                    this.gateRotation = Math.atan2(cy_t - cy, cx_t - cx) * (180 / Math.PI) + 90;
                    knob.style.transform = `rotate(${this.gateRotation}deg)`;
                };
                const end = () => { if (!this.isDragging) return; this.isDragging = false; };
                knob.addEventListener('mousedown', start); knob.addEventListener('touchstart', start);
                window.addEventListener('mousemove', move); window.addEventListener('touchmove', move, { passive: false });
                window.addEventListener('mouseup', end); window.addEventListener('touchend', end);
            },
            resetGateLock() {
                this.state.gateLockIndex = 0; this.state.gateLockSequence = []; this.gateRotation = 0;
                const kn = document.getElementById('gate-knob');
                if(kn) kn.style.transform = `rotate(0deg)`;
                this.updateGateUI();
            },
            confirmGateSelection() {
                const letters = ['A','B','C','D','E','F','G']; 
                let deg = this.gateRotation % 360; if (deg < 0) deg += 360;
                let index = Math.round(deg / (360/7)) % 7;
                this.state.gateLockSequence.push(letters[index]);
                this.state.gateLockIndex++;
                if (this.state.gateLockIndex < 7) this.updateGateUI();
                else {
                    if (this.state.gateLockSequence.join('') === 'CEAGBDF') this.completeStage('gate');
                    else { this.toast('排序錯誤，系統重置'); this.resetGateLock(); }
                }
            },
            updateGateUI() {
                const seq = document.getElementById('gate-seq-num'), prog = document.getElementById('gate-progress');
                if(seq) seq.innerText = Math.min(this.state.gateLockIndex + 1, 7);
                if(prog) {
                    prog.innerHTML = '';
                    for(let i=0; i<7; i++) {
                        const isLocked = i < this.state.gateLockIndex;
                        prog.innerHTML += `<div class="w-8 h-10 border ${isLocked?'bg-fuchsia-600 text-white border-fuchsia-400':'bg-ntu-card text-slate-600 border-ntu-border'} rounded flex items-center justify-center font-mono font-bold">${isLocked?this.state.gateLockSequence[i]:'?'}</div>`;
                    }
                }
            },

            getWafflePuzzle() {
                return `<div class="space-y-4 mb-6">${['E,G,G','B,E,E,F','C,A,B,B,A,G,E'].map((n, i) => `<div class="bg-ntu-bg border border-ntu-border p-4 rounded flex items-center gap-3"><button onclick="app.playMelody(['${n.split(',').join("','")}'])" class="bg-purple-600 w-8 h-8 rounded-full flex items-center justify-center"><i class="fa-solid fa-play text-xs text-white"></i></button><input type="text" id="waffle-q${i+1}" class="term-input flex-1 p-1 text-center uppercase" placeholder="TYPE HERE"></div>`).join('')}</div><button onclick="app.checkWaffle()" class="w-full btn-neon py-3">提交驗證</button>`;
            },
            initWaffleEvents() {},
            checkWaffle() {
                const ans = ['EGG','BEEF','CABBAGE']; let c = 0;
                ans.forEach((a, i) => { if(document.getElementById(`waffle-q${i+1}`).value.trim().toUpperCase() === a) c++; });
                if(c===3) this.completeStage('waffle'); else this.toast(`答對 ${c}/3 題`);
            },

            getBellPuzzle() {
                return `<div class="space-y-4"><input type="number" id="bell-q1" placeholder="Q1 音速 v" class="w-full bg-transparent border border-ntu-border p-3 rounded text-white"><input type="number" id="bell-q2" placeholder="Q2 假喇叭提早多久播放" class="w-full bg-transparent border border-ntu-border p-3 rounded text-white"><input type="number" id="bell-q3" placeholder="Q3 距離遲到還有多少時間" class="w-full bg-transparent border border-ntu-border p-3 rounded text-white"></div><button onclick="app.checkBellAns()" class="w-full btn-neon py-3 mt-4">提交驗證</button>`;
            },
            checkBellAns() {
                let c = 0;
                if(document.getElementById('bell-q1').value == '340') c++;
                if(document.getElementById('bell-q2').value == '11.4') c++;
                if(document.getElementById('bell-q3').value == '72') c++;
                if(c === 3) this.completeStage('bell'); else this.toast(`答對 ${c}/3 題`);
            },

            getLibraryPuzzle() {
                return `<div class="space-y-4"><input type="number" id="lib-q1" placeholder="Q1 AB距離多遠" class="w-full bg-transparent border border-ntu-border p-3 rounded text-white"><input type="number" id="lib-q2" placeholder="Q2 奎哥站在多高的位置" class="w-full bg-transparent border border-ntu-border p-3 rounded text-white"></div><button onclick="app.checkLibraryAns()" class="w-full btn-neon py-3 mt-4">提交驗證</button>`;
            },
            initLibraryEvents() {},
            checkLibraryAns() {
                let c = 0;
                if(document.getElementById('lib-q1').value == '90') c++;
                if(document.getElementById('lib-q2').value == '21') c++;
                if(c === 2) this.completeStage('library'); else this.toast(`答對 ${c}/2 題`);
            },

            getSubwayPuzzle() {
                const opt = ['台北車站', '新店', '秀朗橋', '南勢角', '雙連', '忠孝復興', '龍山寺', '中和', '行天宮', '小碧潭'];
                return `<div class="grid grid-cols-2 gap-3 mb-4">${opt.map(o => `<label class="bg-ntu-card p-3 rounded border border-ntu-border flex items-center gap-2 select-none"><input type="checkbox" name="subway-opt" value="${o}"> <span class="text-sm text-slate-300">${o}</span></label>`).join('')}</div><button onclick="app.checkSubwayAns()" class="w-full btn-neon py-3">提交驗證</button>`;
            },
            checkSubwayAns() {
                const cor = ['台北車站', '新店', '秀朗橋', '南勢角', '龍山寺', '行天宮', '小碧潭'];
                const chk = Array.from(document.querySelectorAll('input[name="subway-opt"]:checked')).map(el => el.value);
                if (cor.length === chk.length && cor.every(v => chk.includes(v))) this.completeStage('subway');
                else this.toast('選擇錯誤');
            },

            getLakePuzzle() {
                return `<input type="text" id="ans-lake" placeholder="輸入五字詩句" class="term-input w-full p-2 text-center text-lg mb-4"><button onclick="app.checkAnswerText('lake', 'ans-lake', ['對影成三人'])" class="w-full btn-neon py-3">提交驗證</button>`;
            },
            getGymPuzzle() {
                return `<input type="text" id="ans-gym" placeholder="輸入數值" class="term-input w-full p-2 text-center text-lg mb-4"><button onclick="app.checkAnswer('gym', 'ans-gym', '-1')" class="w-full btn-neon py-3">提交驗證</button>`;
            },

            checkAnswer(id, inp, ans) {
                const val = document.getElementById(inp).value.trim();
                if (val === ans) this.completeStage(id);
                else { this.toast('答案錯誤'); this.highlightError(inp); }
            },
            checkAnswerText(id, inp, anss) {
                const val = document.getElementById(inp).value.trim();
                if (anss.includes(val)) this.completeStage(id);
                else { this.toast('答案錯誤'); this.highlightError(inp); }
            },
            highlightError(id) {
                const el = document.getElementById(id);
                if (el) { el.classList.add('border-red-500'); setTimeout(()=>el.classList.remove('border-red-500'), 1000); }
            },

            completeStage(id) {
                if (!this.state.completedStages.includes(id)) {
                    this.state.completedStages.push(id);
                    this.saveProgress();
                    const c = STAGES[id].code;
                    const cont = document.getElementById('app-container');
                    if (cont) {
                        cont.innerHTML = `
                            <div class="h-full flex flex-col items-center justify-center fade-in text-center">
                                <div class="w-24 h-24 rounded-full bg-ntu-card border border-fuchsia-500 flex items-center justify-center mb-6 shadow-[0_0_15px_rgba(217,70,239,0.5)]"><i class="fa-solid fa-unlock text-4xl text-white"></i></div>
                                <h2 class="text-3xl font-bold text-white mb-4">解鎖成功</h2>
                                <div class="bg-ntu-bg border border-ntu-border rounded p-4 mb-8"><div class="text-xs text-slate-500 mb-1">獲得金鑰碎片</div><div class="text-4xl font-mono font-bold text-white">${c}</div></div>
                                <button onclick="app.navigate('mission')" class="px-8 py-3 bg-slate-700 rounded text-white font-bold hover:bg-slate-600 transition">前往下一站</button>
                            </div>`;
                    }
                } else this.render();
            },

            renderClues(container) {
                const route = TEAM_ROUTES[this.state.teamId];
                let html = `<div class="grid grid-cols-2 gap-3">`; 
                route.forEach(k => {
                    const s = STAGES[k], u = this.state.completedStages.includes(k);
                    html += `<div class="ntu-card aspect-square flex flex-col items-center justify-center transition border border-transparent ${u ? 'hover:border-fuchsia-500/50':''}">${u ? `<span class="text-5xl font-bold text-fuchsia-400 font-mono mb-2 drop-shadow-neon">${s.code}</span><span class="text-xs text-slate-400 font-bold">${s.name}</span>` : `<i class="fa-solid fa-lock text-3xl text-slate-800"></i>`}</div>`;
                });
                container.innerHTML = html + `</div>`;
            },

            renderFinal(container) {
                const route = TEAM_ROUTES[this.state.teamId];
                const ok = this.state.completedStages.length === route.length;
                container.innerHTML = `
                    <div class="ntu-card p-8 text-center">
                        <i class="fa-solid fa-shield-halved text-6xl mb-6 ${ok?'text-red-500 animate-pulse':'text-slate-700'}"></i>
                        <p class="text-sm text-slate-400 mb-6 font-mono">請輸入完整的「智慧之鑰」以解鎖系統。</p>
                        <div class="flex items-center justify-center gap-2 mb-6">
                            <input type="text" id="final-part1" class="w-24 bg-ntu-bg border-2 border-slate-600 rounded p-3 text-center text-white font-mono text-xl" maxlength="4" ${!ok?'disabled':''}>
                            <span class="text-slate-500 text-xl">_</span>
                            <input type="text" id="final-part2" class="w-24 bg-ntu-bg border-2 border-slate-600 rounded p-3 text-center text-white font-mono text-xl" maxlength="4" ${!ok?'disabled':''}>
                        </div>
                        ${ok ? `<button onclick="app.checkFinal()" class="w-full bg-red-600 text-white font-bold py-3 rounded hover:bg-red-500 transition active:scale-95">執行解密程序</button>` : `<div class="text-xs text-red-400 bg-red-500/10 p-2 rounded border border-red-500/20"><i class="fa-solid fa-lock mr-1"></i> 存取被拒：需先完成 8 項任務</div>`}
                    </div>`;
            },

            checkFinal() {
                const p1 = document.getElementById('final-part1').value.trim().toUpperCase(), p2 = document.getElementById('final-part2').value.trim().toUpperCase();
                if (btoa(`${p1}_${p2}`) === FINAL_ANSWER_HASH) {
                    const cont = document.getElementById('app-container');
                    if (cont) {
                        cont.innerHTML = `
                            <div class="h-full flex flex-col items-center justify-center text-center px-4 fade-in">
                                <div class="bg-emerald-500/10 border-2 border-emerald-500 p-8 rounded-lg shadow-[0_0_20px_rgba(16,185,129,0.2)]">
                                    <div class="w-16 h-16 bg-emerald-500 rounded-full flex items-center justify-center mx-auto mb-6"><i class="fa-solid fa-check text-3xl text-ntu-bg"></i></div>
                                    <h2 class="text-3xl font-bold text-white mb-4 tracking-tighter">ACCESS GRANTED</h2>
                                    <p class="text-slate-300 leading-relaxed">恭喜你任務圓滿完成！<br>歡迎截圖此畫面回傳工作人員，也祝你如願考取理想校系。</p>
                                    <div class="mt-8 pt-6 border-t border-emerald-500/30 text-[10px] text-emerald-500 font-mono">HASH: ${Date.now().toString(16).toUpperCase()}</div>
                                </div>
                            </div>`;
                    }
                } else this.toast('代碼錯誤 (ACCESS DENIED)');
            },

            getDist(lat1, lon1, lat2, lon2) {
                const R = 6371; const dLat = (lat2-lat1)*(Math.PI/180), dLon = (lon2-lon1)*(Math.PI/180);
                const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*(Math.PI/180))*Math.cos(lat2*(Math.PI/180)) * Math.sin(dLon/2)*Math.sin(dLon/2);
                return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
            }
        };

        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
